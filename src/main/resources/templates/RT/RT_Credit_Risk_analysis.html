<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Risk Insights — Credit Risk</title>

	<!-- CSS Dependencies -->
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/css/datatables.min.css}">
	<link rel="stylesheet" th:href="@{/css/CustomButton.css}">
	<link rel="stylesheet" th:href="@{/css/all.min.css}">
	<script th:src="@{/js/echarts.min.js}"></script>
	<link rel="icon" th:href="@{/images/Bornfire.png}" type="image/x-icon">
	<link rel="stylesheet" type="text/css" href="/webjars/font-awesome/5.9.0/css/all.min.css"
		th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
	<style>
		:root {
			--bg: #f9fbff;
			--surface: #ffffff;
			--border: #e6eaf0;
			--text: #0f172a;
			--muted: #6b7280;
			--textcolorheaderwhite: white;
			--processing: #3b82f6;
			--approved: #16a34a;
			--rejected: #ef4444;
			--pending: #f59e0b;
			--refunded: #8b5cf6;

			/* Primary Colors */
			--color-primary: #8b5cf6;
			--color-primary-hover: #7c3aed;
			--color-primary-50: rgba(139, 92, 246, 0.05);
			--color-primary-100: rgba(139, 92, 246, 0.1);
			--color-primary-200: rgba(139, 92, 246, 0.2);
			/* Semantic Colors */
			--color-success: #10b981;
			--color-success-50: rgba(16, 185, 129, 0.05);
			--color-success-100: rgba(16, 185, 129, 0.1);
			--color-warning: #f59e0b;
			--color-warning-50: rgba(245, 158, 11, 0.05);
			--color-warning-100: rgba(245, 158, 11, 0.1);
			--color-error: #ef4444;
			--color-error-50: rgba(239, 68, 68, 0.05);
			--color-error-100: rgba(239, 68, 68, 0.1);
			--color-info: #3b82f6;
			--color-info-50: rgba(59, 130, 246, 0.05);
			--color-info-100: rgba(59, 130, 246, 0.1);
			/* Text Colors */
			--color-text: #1e293b;
			--color-text-secondary: #475569;
			--color-text-muted: #94a3b8;
			/* Background Colors */
			--color-background: #ffffff;
			--color-surface: #f8fafc;
			--color-surface-hover: #f1f5f9;
			/* Border Colors */
			--color-border: #e2e8f0;
			/* Typography */
			--font-primary: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			--text-xs: 0.75rem;
			--text-sm: 0.875rem;
			--text-base: 1rem;
			--text-lg: 1.125rem;
			--text-xl: 1.25rem;
			--text-2xl: 1.5rem;
			--text-3xl: 1.75rem;
			--text-4xl: 2rem;
			/* Font Weights */
			--weight-normal: 400;
			--weight-medium: 500;
			--weight-semibold: 600;
			--weight-bold: 700;
			/* Spacing */
			--space-xs: 0.25rem;
			--space-sm: 0.5rem;
			--space-base: 0.75rem;
			--space-md: 1rem;
			--space-lg: 1.5rem;
			--space-xl: 2rem;
			--space-2xl: 3rem;
			--space-3xl: 4rem;
			/* Border Radius */
			--radius-sm: 0.25rem;
			--radius-md: 0.5rem;
			--radius-lg: 0.75rem;
			--radius-xl: 1rem;
			--radius-full: 9999px;
			/* Shadows */
			--shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
			--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
			/* Layout */
			--sidebar-width: 260px;
			--sidebar-collapsed-width: 80px;
			--header-height: 64px;
			/* Transitions */
			--transition: 0.2s ease;
		}

		body {
			padding: 0;
			margin: 0;
			margin-top: 5px;
			background: var(--bg);
			font-family: Arial, sans-serif;
		}

		.container-fluid {
			margin-top: 130px;
		}

		.menuname {
			width: 100%;
			display: flex;
			justify-content: flex-end;
			/* push content to RIGHT */
			align-items: center;

			padding: 10px 20px;
			/* spacing around text */
			margin-bottom: 10px;
			/* space below header */

			background: brown;
			/* light clean background */
			border-bottom: 2px solid #E3E6EF;

			color: white;
			/* BOB theme navy */
			font-family: "Inter", Arial, sans-serif;
		}

		.menuname h3 {
			margin: 0;
			font-size: 1.1rem;
			/* clean, readable */
			font-weight: 600;
			letter-spacing: 0.5px;
			text-transform: uppercase;
			/* optional, looks like menu-title */
		}

		.menuname label {
			margin: 0;
			padding-left: 10px;
			padding-right: 5px;
			font-size: 1.1rem;
			/* clean, readable */
			font-weight: 600;
			letter-spacing: 0.5px;
			text-transform: uppercase;
			/* optional, looks like menu-title */
		}

		/* Card‐like wrapper for table */
		.table-wrap {
			overflow: auto;
			background: var(--surface);
			box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
			width: 100%;
			margin-bottom: 20px;
		}

		.table.refund-table {
			background: var(--surface);
			color: var(--text);
			margin-bottom: 0;
		}

		.table.refund-table thead th {
			position: sticky;
			top: 0;
			background-color: brown;
			color: var(--textcolorheaderwhite);
			font-weight: 700;
			font-size: 0.65rem;
			border: 2px solid;
			text-transform: uppercase;
		}

		.table.refund-table tbody td {
			font-size: 0.70rem;
			border: 2px solid;
			border-color: var(--border);
		}

		.table.refund-table tbody tr:hover {
			background: #f8fafc;
		}

		.blink-bg {
			animation: blinkBackground 0.5s ease-in-out;
			animation-iteration-count: 30;
			/* Blink 10 times */
		}
		.clickable {
		    cursor: pointer;
		    color: #007bff;
		    text-decoration: underline;
		}
		.clickable:hover {
		    color: #0056b3;
		}

		h4 {
			text-align: left;
			margin-bottom: 30px;
			font-size: 0.70rem;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
			padding: 10px;
		}

		@keyframes blinkBackground {
			0% {
				background-color: yellow;
			}

			50% {
				background-color: red;
			}

			100% {
				background-color: yellow;
			}
		}

		@media (max-width: 767.98px) {
			.table.refund-table thead {
				display: none;
			}

			.table.refund-table,
			.table.refund-table tbody,
			.table.refund-table tr,
			.table.refund-table td {
				display: block;
				width: 100%;
			}

			.table.refund-table tr {
				margin: 0.75rem 0;
				padding: 1rem;
				border-radius: 10px;
				background: var(--surface);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			}

			.table.refund-table tbody td::before {
				content: attr(data-label);
				font-weight: bold;
				color: var(--muted);
				display: block;
				margin-bottom: 5px;
			}
		}
	</style>
</head>

<body>
	<div th:insert="~{XBRLHeaderMenu :: header}" class="fixed-top"></div>

	<div class="container-fluid main-content">
		<div class="menuname">
			<h3 th:text="${menuname}">Menu Name</h3>
			<label>Report Date : </label>
			<input type="date" id="Report_date" class="form-control-sm" style="border: none;
			padding-left: 20px;border-radius: 2px;justify-content: center;
			font-family: Verdana, Geneva, Tahoma, sans-serif;" name="Report_date"
				th:value="${#dates.format(Report_date, 'yyyy-MM-dd')}" onchange="GetExposuredata();" />

		</div>

		<div th:if="${formmode}=='Portfolio_analysis'">
			<!-- chart container -->

			<div class="col-lg-12 col-md-12 col-sm-12 d-flex gap-3">
				<div id="Branchchart" style="flex:1; height:400px; background:white; border-radius:8px;"></div>
				<div id="Categorychart" style="flex:1; height:400px; background:white; border-radius:8px;"></div>
			</div>
			<!-- segment detail panel -->
			<div id="detailsPanel" style="margin-top:10px; font-size:16px;margin-left: 25%;">
				<b>Selected Branch:</b> <span id="segmentName" style="color: #7c3aed;">None</span> |
				<b>Percentage and Exposure Balance:</b> <span id="segmentValue" style="color: #7c3aed;">0%</span>
			</div>


			<div class="table-wrap" style="padding-top: 10px;">
				<table class="table refund-table align-middle mb-0" id="Portfolio_summary_table">
					<thead>
						<tr>
							<th colspan="17" style="text-align: center;">Branch-wise Portfolio Risk Snapshot</th>
						</tr>
						<tr>
							<th>Branch</th>
							<th>Book Exposure (AED)</th>
							<th>RWA (AED)</th>
							<th>RWA / Exposure (%)</th>
							<th>No. of Active Accounts</th>
							<th>Active Accounts Exposure (AED)</th>
							<th>No. of NPA Accounts</th>
							<th>NPA Accounts Exposure (AED)</th>
							<th>No. of Watchlist Accounts</th>
							<th>Watchlist Exposure (AED)</th>
							<th>No. of Overdue Accounts</th>
							<th>Overdue Exposure (AED)</th>
						</tr>
					</thead>
					<tbody id="Summary_value_body">
					</tbody>
				</table>
			</div>


			<div class="table-wrap" style="padding-top: 10px;">
				<table class="table refund-table align-middle mb-0" id="Portfolio_analy_table">
					<thead>
						<tr>
							<th colspan="17" style="text-align: center;">Top 10 Exposure Accounts – Portfolio Snapshot / Chart Category</th>
						</tr>
						<tr>
							<th>Branch Name</th>
							<th>Account Name</th>
							<th>Gl Code</th>
							<th>Constitution Code</th>
							<th>Purpose of Advn</th>
							<th>Scheme</th>
							<th>Rwa Class</th>
							<th>Int Suspense</th>
							<th>Total Provision</th>
							<th>Limit</th>
							<th>Balance</th>
							<th>Exposure</th>
							<th>RW</th>
							<th>RWA</th>
							<th>Total Drawn RWA</th>
							<th>Total Rwa</th>
						</tr>
					</thead>
					<tbody id="Portfolio_analy_body">
					</tbody>
				</table>
			</div>
		</div> <!--This is the div for end of portfolio formmode-->
	</div>

	<!-- Chart Script AFTER container -->
	<script th:inline="javascript">

		/*<![CDATA[*/

		// rawData will be an array of objects with fields: classification, exposureperc, exposurebal
		var rawData = /*[[${Analysistabledata}]]*/[];
		var formmode = /*[[${formmode}]]*/'';
		var Centralized_Report_date = /*[[${Report_date}]]*/'';
		/*]]>*/

	</script>

	<script>
		// Guard if div is not present
		///Branch Wise portfolio exposure 
		var branchdom = document.getElementById('Branchchart');
		if (branchdom) {
		    var myChart = echarts.init(branchdom);

		    // Convert rawData -> ECharts 'data' format
		    var chartData = (rawData || []).map(function (item) {
		        return {
		            value: item.exposureperc,   // numeric percentage
		            name: item.classification,  // label
		            exposureBal: item.exposurebal
		        };
		    });

		    // === NEW: total exposure balance for center text ===
		    var totalExposureBal = chartData.reduce(function (sum, item) {
		        var v = Number(item.exposureBal) || 0;
		        return sum + v;
		    }, 0);

		    var totalExposureBalFmt = totalExposureBal.toLocaleString('en-US', {
		        minimumFractionDigits: 2,
		        maximumFractionDigits: 2
		    });

		    var option = {
		        backgroundColor: '#FFFFFF',
		        tooltip: {
		            trigger: 'item',
		            formatter: function (params) {
		                var bal = params.data.exposureBal || 0;
		                var balFmt = bal.toLocaleString('en-US', {
		                    minimumFractionDigits: 2,
		                    maximumFractionDigits: 2
		                });

		                return [
		                    '<b>' + params.name + '</b>',
		                    'Share: ' + params.percent.toFixed(2) + '%',
		                    'Exposure: ' + balFmt + ' AED (Mn)'
		                ].join('<br/>');
		            }
		        },
		        title: {
		            left: 'center',
		            top: 10,
		            textStyle: { color: '#1B4F72', fontSize: 12 }
		        },

		        // === NEW: center label in the donut ===
		        graphic: {
		            type: 'text',
		            left: 'center',
		            top: 'middle',
		            style: {
		                text: 'Total\n' + totalExposureBalFmt + ' AED (Mn)',
		                textAlign: 'center',
		                fill: '#333',
		                fontSize: 12,
		                fontWeight: 'bold'
		            }
		        },

		        series: [{
		            name: 'Classification',
		            type: 'pie',
		            radius: ['40%', '70%'],
		            avoidLabelOverlap: true,
		            label: {
		                show: true,
		                position: 'outside',
		                formatter: '{b}: {d}%'
		            },
		            labelLine: { show: true },
		            data: chartData
		        }],
		        color: ['#D81B60', '#8E24AA', '#5E35B1', '#3F51B5', '#4CAF50', '#DCE775', '#FFA726', '#FCC6BB']
		    };

		    myChart.setOption(option);

		    // click event for details panel
		    myChart.on('click', function (params) {
		        var bal = params.data.exposureBal || 0;
		        var balFmt = bal.toLocaleString('en-US', {
		            minimumFractionDigits: 2,
		            maximumFractionDigits: 2
		        });

		        document.getElementById('segmentName').textContent = params.name;
		        document.getElementById('segmentValue').textContent =
		            params.percent.toFixed(2) + '% ' + balFmt + ' AED (Mn)';

		        // From the Branch Pie chart > to get the category wise data
		        categorywisedata(params.name);
		        BranchPortfoliorisksnapshot('Branchsnapshot');
		    });

		    window.addEventListener('resize', function () {
		        myChart.resize();
		    });
		}

		///This is the chart is used to plot the categiry wise Exposure
		function categorychart(Categorydata) {
			//Category Wise portfolio Exposure
			var categorydom = document.getElementById('Categorychart');

			var myChart = echarts.init(categorydom);
			// Convert rawData -> ECharts 'data' format
			// rawData[i] looks like: { classification: "...", exposureperc: 45.0, exposurebal: 123456.78 }
			var Categorydata = (Categorydata || []).map(function (item) {
				return {
					value: item.exposureperc,          // numeric percentage
					name: item.classification,          // label
					exposureBal: item.exposurebal
				};
			});

			var option = {
				backgroundColor: '#FFFFFF',
				tooltip: {
					trigger: 'item',
					formatter: function (params) {
						// params.data.exposureBal is your absolute balance (AED)
						var bal = params.data.exposureBal || 0;
						// basic number formatting; you can change to your style
						var balFmt = bal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

						return [
							'<b>' + params.name + '</b>',
							'Share: ' + params.percent.toFixed(2) + '%',
							'Exposure: ' + balFmt + ' AED (Mn)'
						].join('<br/>');
					}
				},
				title: {

					left: 'center',
					top: 10,
					textStyle: {color: '#1B4F72', fontSize: 12}
				},
				series: [{
					name: 'Classification',
					type: 'pie',
					radius: ['40%', '70%'],
					avoidLabelOverlap: true,
					label: {
						show: true,
						position: 'outside',
						formatter: '{b}: {d}%'
					},
					labelLine: {show: true},
					data: Categorydata
				}],
				color: ['#D81B60', '#8E24AA', '#5E35B1', '#3F51B5', '#4CAF50', '#DCE775', '#FFA726', '#FCC6BB']
			};

			myChart.setOption(option);

			// click event for details panel
			myChart.on('click', function (categoryparams) {
				var bal = categoryparams.data.exposureBal || 0;
				var balFmt = bal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

				GetTop10Exposureclass(categoryparams.name, 'TopExposuredata');

			});

			window.addEventListener('resize', function () {
				myChart.resize();
			});

		}

		function GetExposuredata() {
			var Selecteddate = document.getElementById("Report_date").value;
			
			location.href = "Credit_risk?formmode=" + formmode + '&Report_date=' + Selecteddate;

		}
		//Get Top 10 List of accounts on selected table
		function GetTop10Exposureclass(classificationName, Data_table_type) {

			var dateParts = Centralized_Report_date.split("-");
			var trHTML = "";
			document.getElementById("Portfolio_analy_body").innerHTML = trHTML;
			const Report_date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
			var Branchname = document.getElementById("segmentName").textContent;
			
			
			
			
			// Build URL-encoded body
			const params = new URLSearchParams({
				Report_date: Report_date,
				classification: classificationName,
				Branch_name: Branchname,
				Data_table_type: Data_table_type
			});

			fetch('./GetExposuredata', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: params.toString()
			})
				.then(response => {
					if (!response.ok) {
						throw new Error("HTTP error " + response.status);
					}
					return response.json();
				})
				.then(list => {
					var trHTML = "";

					// Use plain JS loop; you already use jQuery only for DOM
					list.forEach(function (data) {
						trHTML +=
							"<tr>" +
							"<td>" + (data.branch_name || "") + "</td>" +
							"<td>" + (data.account_name || "") + "</td>" +
							"<td>" + (data.gl_code || "") + "</td>" +
							"<td>" + (data.const_id || "") + "</td>" +
							"<td>" + (data.purpose || "") + "</td>" +
							"<td>" + (data.scheme || "") + "</td>" +
							"<td>" + (data.rwa_class || "") + "</td>" +
							"<td>" + (formatNumber(data.int_suspense) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.tot_provision) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.limit) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.balance) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.exposure) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.rw) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.rwa) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.total_drawn_rwa) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.total_rwa) || "0.00") + "</td>" +
							"</tr>";
					});

					// Replace body content
					document.getElementById("Portfolio_analy_body").innerHTML = trHTML;
				})
				.catch(error => {
					alert("Error fetching exposure data: " + error.message);
					$("#invalidfile").modal("toggle");
				});
		}

		///To take the Branchwise portfolio details
		function BranchPortfoliorisksnapshot(Data_table_type) {



			var dateParts = Centralized_Report_date.split("-");
			var trHTML = "";
			document.getElementById("Summary_value_body").innerHTML = trHTML;
			const Report_date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
			var Branchname = document.getElementById("segmentName").textContent;
			// Build URL-encoded body
			const params = new URLSearchParams({
				Report_date: Report_date,
				Branch_name: Branchname,
				Data_table_type: Data_table_type
			});

			fetch('./GetExposuredata', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: params.toString()
			})
				.then(response => {
					if (!response.ok) {
						throw new Error("HTTP error " + response.status);
					}
					return response.json();
				})
				.then(list => {
					var trHTML = "";

					list.forEach(function (data) {
						trHTML +=
							"<tr>" +
							"<td>" + (data.branch_name || "") + "</td>" +

							// BALANCE clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchTotExp\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.balance) || "0.00") +
							"</a></td>" +

							// TOTAL RWA clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchTotRWA\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.total_rwa) || "0.00") +
							"</a></td>" +

							"<td>" + (formatNumber(data.limit) || "0.00") + "</td>" +
							"<td>" + (formatNumber(data.adjusted_fdr) || "0.00") + "</td>" +

							// CRM clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchActvExp\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.crm) || "0.00") +
							"</a></td>" +

							"<td>" + (formatNumber(data.crm_adj_bal) || "0.00") + "</td>" +

							// CRM GNT clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchNPAExp\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.crm_gnt_adj_bal) || "0.00") +
							"</a></td>" +

							"<td>" + (formatNumber(data.rw) || "0.00") + "</td>" +

							// RWA clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchWatchExp\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.rwa) || "0.00") +
							"</a></td>" +

							"<td>" + (formatNumber(data.bill_amount) || "0.00") + "</td>" +

							// BILL DISC clickable
							'<td><a href="#" class="clickable" onclick="GetTop10Exposureclass(\'BranchOverdueExp\', \'Branchsnapshotdetail\')">' +
							(formatNumber(data.bill_disc_rwa) || "0.00") +
							"</a></td>" +

							"</tr>";
					});


					// Replace body content
					document.getElementById("Summary_value_body").innerHTML = trHTML;
				})
				.catch(error => {
					alert("Error fetching exposure data: " + error.message);
					$("#invalidfile").modal("toggle");
				});

		}

		function categorywisedata(branchname) {

			var dateParts = Centralized_Report_date.split("-");

			const Report_date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

			fetch("./Getcategorychart?Branch_name=" + branchname + "&Report_date=" + Report_date) // your API URL
				.then(response => response.json())
				.then(result => {
					categorychart(result);
				});
		}

		///Format the number
		function formatNumber(value) {
			if (!value) return "0";
			return Number(value).toLocaleString("en-US", {
				minimumFractionDigits: 0,
				maximumFractionDigits: 0
			});
		}


	</script>



</body>

</html>