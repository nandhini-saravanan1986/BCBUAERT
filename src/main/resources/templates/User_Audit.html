<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" type="text/css" href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/font-awesome/5.9.0/css/all.min.css"
	th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
	th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
	th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">
<link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="stylesheet" th:href="@{/css/CustomButton.css}" />
	
<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
	th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
	th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
<script src="/webjars/jquery/3.4.1/jquery.min.js" th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
	th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>
<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="/webjars/jquery/3.6.0/jquery.min.js" th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
<script src="/webjars/bootstrap/4.6.0/js/bootstrap.bundle.min.js"
	th:src="@{/webjars/bootstrap/4.6.0/js/bootstrap.bundle.min.js}"></script>
<script src="/webjars/datatables.net/1.13.4/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables.net/1.13.4/js/jquery.dataTables.min.js}"></script>
											
		
		<style>

									
									
									
									body {
			    font-family: 'Segoe UI', Arial, sans-serif;
			    font-size: 14px;}
				
				
				
				.table .thead-light th {
			    color: #495057;
			    background-color: #e9ecef;
			    border-color: #dee2e6;
				font-family: sans-serif;
			}
								/* === ROLE PAGE CUSTOM HEADER === */
								.role-page-header {
								    background-color: #ffffff;
								    padding: 15px 20px;
								}

								.role-page-title h4 {
								    color: #003366;
								    font-family: "Segoe UI", Arial, sans-serif;
								    font-size: 20px;
								    font-weight: 700;
								    margin: 0;
								}

								.role-page-underline {
								    width: 158px;
								    height: 3px;
								    background-color: #0073e6;
								    border-radius: 2px;
								    margin-top: 6px;
								    box-shadow: 0 4px 12px rgba(0, 115, 230, 0.6); /* soft glow below */
								}


								/* Add Button Styling */
								.role-add-btn {
								    background: linear-gradient(135deg, #005fa3, #007bff);
								    color: #fff;
								    border: none;
								    border-radius: 25px;
								    padding: 8px 18px;
								    font-size: 13px;
								    font-weight: 600;
								    cursor: pointer;
								    box-shadow: 0 2px 5px rgba(0, 64, 128, 0.2);
								    transition: all 0.3s ease;
								}

								.role-add-btn:hover {
								    background: linear-gradient(135deg, #007bff, #3399ff);
								    transform: translateY(-2px);
								    box-shadow: 0 0 10px rgba(0, 102, 204, 0.4);
								}

								.role-add-btn i {
								    margin-right: 5px;
								}

								
							</style>
							<script>
								function goBack() {
								    window.history.back();
								}

								function goForward() {
								    window.history.forward();
								}

								// Detect mouse near screen edges
								document.addEventListener('mousemove', function(e) {
								    const backBtn = document.getElementById('floatingBackBtn');
								    const forwardBtn = document.getElementById('floatingForwardBtn');
								    const screenWidth = window.innerWidth;

								    // Left edge (back)
								    if (e.clientX < 50) {
								        backBtn.classList.add('show');
								    } else {
								        backBtn.classList.remove('show');
								    }

								    // Right edge (forward)
								    if (screenWidth - e.clientX < 50) {
								        forwardBtn.classList.add('show');
								    } else {
								        forwardBtn.classList.remove('show');
								    }
								});
								</script>

								<style>
								/* Shared styles for both buttons */
								#floatingBackBtn, 
								#floatingForwardBtn {
								    position: fixed;
								    top: 50%;
								    background-color: #0073e6;
								    border: none;
								    color: white;
								    font-size: 20px;
								    border-radius: 50%;
								    width: 45px;
								    height: 45px;
								    display: flex;
								    align-items: center;
								    justify-content: center;
								    opacity: 0;
								    pointer-events: none;
								    transition: all 0.4s ease;
								    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
								    z-index: 999;
								}

								/* Back button */
								#floatingBackBtn {
								    left: -50px; /* hidden off-screen */
								}

								/* Forward button */
								#floatingForwardBtn {
								    right: -50px; /* hidden off-screen */
								}

								/* Show when near edge */
								#floatingBackBtn.show {
								    left: 20px;
								    opacity: 1;
								    pointer-events: auto;
								}

								#floatingForwardBtn.show {
								    right: 20px;
								    opacity: 1;
								    pointer-events: auto;
								}

								/* Hover animation */
								#floatingBackBtn:hover,
								#floatingForwardBtn:hover {
								    background-color: #005bb5;
								    transform: scale(1.1);
								}
								</style>	
		<style>
				/* Red border for invalid inputs */
				input.error,
				select.error {
					border: 2px solid red !important;
				}

				/* Error message style */
				label.error {
					color: red;
					font-size: 0.85em;
					margin-top: 5px;
					display: block;
				}

				.underline {
					text-decoration: underline;
					color: #08a6f1;
					cursor: pointer;
				}

				.left-arrow-circle {
					width: 35px;
					height: 35px;
					border-radius: 50%;
					background-color: white;
					display: flex;
					align-items: center;
					justify-content: center;
					margin-right: 10px;
					transition: background-color 0.3s, transform 0.2s;
				}

				.left-arrow-circle i {
					color: rgb(107, 122, 143);
				}

				.left-arrow-circle:hover {
					background-color: rgb(107, 122, 143);
					cursor: pointer;
					transform: scale(1.05);
					border: 2px solid white;
				}

				.left-arrow-circle:hover i {
					color: white;
				}

				.white-text span {
					color: white !important;


				}
			</style>
	<style>
		
	.btns {
		float: right;
		margin: 5px;
	}

	.col-sm-5 {
		padding-bottom: 15px;
	}

	.list-body {
		padding: 0px;
	}

	.error {
		color: red;
		padding-left: 10px;
	}

	.formline {
		padding-bottom: 15px;
	}

	.btn-primary {
		background-color: #E77400;
		border-color: #0c0c0c;
	}

	.btn-primary:not(:disabled):not(.disabled).active,
	.btn-primary:not(:disabled):not(.disabled):active,
	.show > .btn-primary.dropdown-toggle {
	    color: #fff;
	    background-color: #cc0000;
	    border-color: #161617;
	}


	#finusertb {
		width: 460px;
	}

	.dataTables_wrapper .dataTables_paginate .paginate_button {
		padding: 0px;
	}
	</style>							
	<style>
		/* Red border for invalid inputs */
		input.error,
		select.error {
			border: 2px solid red !important;
		}

		/* Error message style */
		label.error {
			color: red;
			font-size: 0.85em;
			margin-top: 5px;
			display: block;
		}

		.underline {
			text-decoration: underline;
			color: #08a6f1;
			cursor: pointer;
		}

		.left-arrow-circle {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			background-color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 10px;
			transition: background-color 0.3s, transform 0.2s;
		}

		.left-arrow-circle i {
			color: rgb(107, 122, 143);
		}

		.left-arrow-circle:hover {
			background-color: rgb(107, 122, 143);
			cursor: pointer;
			transform: scale(1.05);
			border: 2px solid white;
		}

		.left-arrow-circle:hover i {
			color: white;
		}

		.white-text span {
			color: white !important;


		}
	</style>
<script th:inline="javascript">

	/*<![CDATA[*/

	$(document).ready(function () {
		var userAuditLevelData = /*[[${userAuditLevels}]]*/[];

		userAuditLevelData.forEach(function (item) {
			if (item.audit_date) {

				const dateObj = new Date(item.audit_date);
				if (!isNaN(dateObj)) {
					const yyyy = dateObj.getFullYear();
					const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
					const dd = String(dateObj.getDate()).padStart(2, '0');
					item.audit_date_filter = `${yyyy}-${mm}-${dd}`;
				} else {
					item.audit_date_filter = '';
				}
			} else {
				item.audit_date_filter = '';
			}
		});

		var table = $('#userAuditLevelTb').DataTable({
			
			destroy: true,
			scrollCollapse: true,
			paging: true,
			autoWidth: false,
			ordering: true,
			searching: false,
			pageLength: 20,
			lengthChange: false,

			data: userAuditLevelData,
			columns: [
				{data: 'audit_ref_no', title: 'Audit Ref No'},
				{
					data: 'audit_date',
					title: 'Audit Date',
					render: function (data) {
						if (!data) return '';
						const date = new Date(data);
						if (isNaN(date)) return data; // fallback if not a valid date
						return date.toLocaleDateString('en-GB'); // format: dd/mm/yyyy
					}
				},
				{data: 'audit_table', title: 'Audit Table'},
				{data: 'func_code', title: 'Function Code'},
				{data: 'entry_user', title: 'Entry User'},
				{data: 'event_name', title: 'Event Name'},
				{
					data: 'entry_time',
					title: 'Entry Time',
					render: function (data) {
						if (!data) return '';
						const time = new Date(data);
						if (isNaN(time)) return data; // fallback if invalid time
						return time.toLocaleTimeString('en-US', {
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}); // Example output: "05:14 PM"
					}
				},

				{data: 'auth_user', title: 'Auth User'},

				{data: 'remarks', title: 'Remarks'}
			]
		});

		// Date filter event
		$('#searchDate').on('change', function () {
			var selectedDate = $(this).val(); // yyyy-mm-dd

			var filteredData = userAuditLevelData.filter(function (item) {
				return item.audit_date_filter === selectedDate;
			});

			table.clear().rows.add(filteredData).draw();
		});
	});



	$(function () {

		/* var fromdate;
		var todate; */
		var tabledata = /*[[${auditlogss}]]*/ null;


		var table = $('#auditlogtb').DataTable({
			"info": false,
			"lengthChange": false,
			data: tabledata,
			columns: [
				{
					"data": "srl_no",
					"title": "SRL NO"
				},
				{
					"data": "log_in_user_id",
					"title": "ENTRY USER ID"
				},
				{
					"data": "log_in_user_name",
					"title": "ENTRY USER NAME"
				},
				{
					"data": "log_in_designation",
					"title": "DESIGNATION"
				},
				{
					"data": "log_in_contact_no",
					"title": "CONTACT NO"
				},
				{
					"data": "log_in_audit_date",
					"title": "LOGIN DATE"
				},
				{
					"data": "new_user_id",
					"title": "CREATE USER ID"
				},
				{
					"data": "new_user_name",
					"title": "CREATE USER NAME"
				}
			]
		});

		$("#downloadfile").on("click", function () {

			var fromdate2 = $("#fromdate").val();
			var todate2 = $("#todate").val();

			var diff = new Date(todate - fromdate);
			// get days
			var days = diff / 1000 / 60 / 60 / 24;
			if (days <= 31) {
				var url = /*[[@{/auditLogs/Download}]]*/null;


				url = url + "?fromdate=" + fromdate2 + "&todate=" + todate2;
				location.href = url;

			} else {

				$("#alertmsg").text("Maximum 31 days only Allowed");
				$("#alert").modal("toggle");
			}
		});


		function format(d) {
			// `d` is the original data object for the row
			var htmlstr;
			var str = d.modified_fields_data;

			var data;
			var modhtml = "";

			if (str != null) {

				data = str.split("|");
				var length = data.length - (data.length % 3);
				var allMods = new Array();
				var count = 0;
				for (i = 0; i < length; i = i + 3) {
					var obj = new Object();
					for (j = i; j < i + 3; j++) {
						if (j % 3 == 0) {
							obj.colname = data[j];
						} else if (j % 3 == 1) {
							obj.oldval = data[j];
						} else {
							obj.newval = data[j];
						}
					}
					console.log(obj);

					allMods[count] = obj;
					count++;

				};

				modhtml = '<tr><td colspan="3">Changed Fields :<td></tr>' +
					'<tr>' +
					'<td>Column Name</td>' +
					'<td>Old Value</td>' +
					'<td>New Value</td>' +
					'</tr>';

				allMods.forEach(function (value) {

					modhtml = modhtml + "<tr><td id='' >" + value.colname + "</td><td id='' class='alnum'>" + value.oldval + "</td><td id='' class='alnum'>" + value.newval + "</td></tr>";

				});

			}

			htmlstr = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
				'<tr>' +
				'<td>Unique Id:</td>' +
				'<td colspan="2">' + d.unique_id + '</td>' +
				'</tr>';

			htmlstr = htmlstr + modhtml + '</table>';

			return htmlstr;
		};


		$('#auditlogtb tbody').on('click', 'td.details-control', function () {
			var tr = $(this).closest('tr');
			var row = table.row(tr);

			if (row.child.isShown()) {
				// This row is already open - close it
				row.child.hide();
				tr.removeClass('shown');
			}
			else {
				// Open this row
				row.child(format(row.data())).show();
				tr.addClass('shown');
			}
		});

	})

	function goHome() {
		window.location.href = '/BRAS/Dashboard';
	}
	function back() {
		window.history.back();
	}
	
	document.addEventListener("DOMContentLoaded", function () {
		const dateInput = document.getElementById("searchDate");
		const today = new Date().toISOString().substr(0, 10);

		// set today as default value
		dateInput.value = today;

		// disable future dates
		dateInput.max = today;

		// initial filter on load
		filterByDate(dateInput.value);

		// handle date change
		dateInput.addEventListener("change", function () {
			filterByDate(this.value);
		});
	});
	document.getElementById("searchDate").addEventListener("change", function () {
		const selectedDate = this.value;
		filterByDate(selectedDate);
	});

	function filterByDate(dateString) {
		const table = document.getElementById("userAuditLevelTb");
		const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

		for (let row of rows) {
			const dateCell = row.cells[4]; // 5th column (Entry Date)
			if (dateCell) {
				// your date format in the table is dd-MM-yyyy
				const cellDateParts = dateCell.textContent.trim().split("-");
				const cellDateFormatted = `${cellDateParts[2]}-${cellDateParts[1]}-${cellDateParts[0]}`; // yyyy-MM-dd
				if (cellDateFormatted === dateString) {
					row.style.display = "";
				} else {
					row.style.display = "none";
				}
			}
		}
	}
</script>


</head>
<title>BRAS</title>

<body>
	<div class="container-fluid">
		<div class="row">
			<div th:insert="XBRLHeaderMenu :: header"></div>
			<div class="col-sm-12">
				<div class="card">
			

					
					<div class="role-page-header d-flex justify-content-between align-items-center">
										    <!-- Left: Page Title -->
										    <div class="role-page-title">
										        <h4 >USER LEVEL AUDIT</h4>
													<div style="width: 178px;
															    height: 3px;
															    background-color: #0073e6;
															    border-radius: 2px;
															    margin-top: 6px;
															    box-shadow: 0 4px 12px rgba(0, 115, 230, 0.6);"></div>
																</div>
																<!-- Right: Add Button -->
																			<div class="form-inline">
																			<label for="reportDate" class="mr-2">Report Date:</label> <input
																				type="date" id="searchDate" name="searchDate"
																				class="form-control form-control-sm" />
																				
																			</div>
										  
										</div>
										
					
					
					
					<form class="form-horizontal" method="post" name="CriteriaForm" id="reportform">
						<div class="form-group">
							<div class="row row1">
								<!-- Additional criteria inputs can go here -->
							</div>
						</div>
					</form>

					
								
					<div class="table-container" style="
					     padding: 0 15px;
					     max-height: 500px;   /* 👈 control height */
					     overflow-y: auto;    /* 👈 enable vertical scroll */
					     overflow-x: hidden;
					">									<table class="table table-striped table-bordered table-hover" id="userAuditLevelTb">
								
										<thead style="background-color: #e9ecf0; " class="thead-light">
											<tr>
									<th>Audit Ref No</th>
									<th>Table Name</th>
									<th>Function</th>
									<th>Entry User</th>
									<th>Entry Date</th>
									<th>Entry Time</th>
									<th>Authorizer</th>
									<th style="width: 250px;">Modified Data</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="auditdata : ${auditlogs}" onclick="navigateToid(this)">
									<td th:text="${auditdata.audit_ref_no}"></td>
									<td th:text="${auditdata.audit_table}"></td>
									<td th:text="${auditdata.func_code}"></td>
									<td th:text="${auditdata.entry_user}"></td>
									<td
										th:text="${auditdata.entry_time != null ? #dates.format(auditdata.entry_time, 'dd-MM-yyyy') : 'N/A'}">
								</td>
									<td
										th:text="${auditdata.entry_time != null ? #dates.format(auditdata.entry_time, 'HH:mm:ss') : 'N/A'}">
									</td>

									<td th:text="${auditdata.auth_user != null ? auditdata.auth_user : 'N/A'}"></td>
									<td th:text="${auditdata.change_details != null ? auditdata.change_details : 'N/A'}"></td>
									
								</tr>
							</tbody>
						</table>
					</div>

					
				</div>
			</div>
			
						
						
							<!-- Floating Back Button -->
			<button id="floatingBackBtn" onclick="goBack()" title="Go Back">
				<i class="fa fa-arrow-left"></i>
			</button>
			<!-- Floating Forward Button -->
			<button id="floatingForwardBtn" onclick="goForward()" title="Go Forward">
			    <i class="fa fa-arrow-right"></i>
			</button>
			<div class="modal fade" id="alert">
				<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content">
						<div class="modal-body" style="text-align: center">
							<p id="alertmsg"></p>
							<button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>