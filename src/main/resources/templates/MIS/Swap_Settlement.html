<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css"
	href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/font-awesome/5.9.0/css/all.min.css"
	th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
	th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
	th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">
<link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="stylesheet" th:href="@{/css/CustomButton.css}" />

<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
	th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
	th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
<script src="/webjars/jquery/3.4.1/jquery.min.js"
	th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
	th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>

<script src="/webjars/jquery-form/4.2.2/jquery.form.min.js"
	th:src="@{/webjars/jquery-form/4.2.2/jquery.form.min.js}"></script>

<script src="/webjars/jquery-validation/1.19.0/jquery.validate.min.js"
	th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>

<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<script
	src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>

<style>
 body {
      margin: 0;
      overflow-x: hidden; /* â›” Prevent full-page scroll */
    }
.btns {
	float: right;
	margin: 5px;
}

.col-sm-5 {
	padding-bottom: 15px;
}

.list-body {
	padding: 0px;
}

.error {
	color: red;
	padding-left: 10px;
}

.formline {
	padding-bottom: 15px;
}

.btn-primary {
	background-color: #E77400;
	border-color: #0c0c0c;
}

.btn-primary:not (:disabled ):not (.disabled ).active, .btn-primary:not
	 (:disabled ):not (.disabled ):active, .show>.btn-primary.dropdown-toggle
	{
	color: #fff;
	background-color: #cc000000;
	border-color: #161617;
}

#finusertb {
	width: 460px;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	padding: 0px;
}
</style>
<style>
        .valids { color: green; }
        .invalids { color: red; }
    </style>
<script th:inline="javascript">
	/*<![CDATA[*/




	function home() {
		location.href = 'Dashboard'
	}

	function back() {
		window.history.back();
	}


	
	function adduser() {
		
		
		location.href = 'counterparty_list?formmode=add';
		
	}

	function list() {
		location.href = 'swap_settlement';
	}

	

	/*]]>*/
</script>

<script>
	function deleteuser() {
		
		var entryuser = document.querySelector('[data-entry_user]');
		var modifyuser = document.querySelector('[data-modify_user]');

		if (confirm('Are you sure you want to delete this User?')) {		
			$("#loader1").modal("toggle");
			var userid = document.getElementById("userId").value;
			$.ajax({
				type : 'post',
				url : './deleteuser?formmode=' + userid,
				success : function(response) {
					$("#loader1").modal("hide");
					$("#alertmsg").text('User Deleted');
					$('#alert').modal("toggle");
				},
	            error: function(xhr, status, error) {
	            	$("#loader1").modal("hide");
	                alert('Not able to delete contact administrator');
	            }
			});
		}
		
	}
</script>
<script>
	function roledesc1() {

		var roleid = $("#roleId").find(':selected').val();

		if (roleid == 'VISAP1') {
			$("#roleDesc1").val("VISAP1");
		} else if (roleid == 'VISAR2') {
			$("#roleDesc1").val("VISAR2");
		} else if (roleid == 'RFI3') {
			$("#roleDesc1").val("RFI3");
		} else if (roleid == 'RFI3') {
			$("#roleDesc1").val("RFI3");
		} else if (roleid == 'CURINT4') {
			$("#roleDesc1").val("CURINT4");
		}
		$(this).find(':selected').text();

	}
	
	function brflogin() {

		var roleid = $("#roleId").find(':selected').val();

		if (roleid == 'VISAP1') {
			$("#roleDesc1").val("VISAP1");
		} else if (roleid == 'VISAR2') {
			$("#roleDesc1").val("VISAR2");
		} else if (roleid == 'RFI3') {
			$("#roleDesc1").val("RFI3");
		} else if (roleid == 'RFI3') {
			$("#roleDesc1").val("RFI3");
		} else if (roleid == 'CURINT4') {
			$("#roleDesc1").val("CURINT4");
		}
		$(this).find(':selected').text();

	}

	function home() {
		location.href = "/MIS/Dashboard";
	}

	function back() {
		window.history.back();
	}
</script>

<script>


function submitform() {
    var iBranchCode = $("#iBranchCode").val().trim();
    var iBranchName = $("#iBranchName").val().trim();
    var reportDate = $("#reportDate").val().trim();
    var fileInput = $("#file")[0].files[0];

    if (!iBranchCode || !iBranchName || !reportDate || !fileInput) {
        alert("All fields are required.");
        return;
    }

    let formData = new FormData();
    formData.append("iBranchCode", iBranchCode);
    formData.append("iBranchName", iBranchName);
    formData.append("reportDate", reportDate);
    formData.append("file", fileInput);
    formData.append("uploadedBy", $("#uploadedBy").val());

    $.ajax({
        url: "./Add_ASL",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
            console.log("Success:", response);
            $("#alertmsg").text(response);
            $('#alert').modal("toggle");
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
            $("#alertmsg").text("Error occurred: " + error);
            $('#alert').modal("toggle");
        }
    });
}


</script>

<script th:inline="javascript">
/*<![CDATA[*/
    var counterlist = /*[[${counterlist}]]*/ [];

    function validatelis(inputElem) {
        var inputVal = inputElem.value.trim().toLowerCase();
        var exists = false;
        var matches = [];

        // Reset previous suggestions
        $("#bankSuggestions").empty().hide();

        // Check for match and collect suggestions
        counterlist.forEach(function (item) {
            if (item.toLowerCase() === inputVal) {
                exists = true;
            } else if (item.toLowerCase().includes(inputVal) && inputVal !== "") {
                matches.push(item);
            }
        });

        // Show tooltip if exists
        if (exists) {
            $("#bankExistsMsg").show();
            $("#generatebtn").hide();
        } else {
            $("#bankExistsMsg").hide();
            $("#generatebtn").show();
        }

        // Show suggestions dropdown
        if (matches.length > 0) {
            matches.forEach(function (suggestion) {
                $("#bankSuggestions").append(
                    "<div class='suggestion-item' style='padding: 5px; cursor: pointer;'>" +
                    suggestion + "</div>"
                );
            });
            $("#bankSuggestions").show();
        }
    }

    // Handle click on suggestion
    $(document).on("click", ".suggestion-item", function () {
        $("#counterPartyBank").val($(this).text());
        $("#bankSuggestions").hide();
        validatelis(document.getElementById("counterPartyBank")); // re-validate after selection
    });

    // Hide suggestions if clicked outside
    $(document).click(function (e) {
        if (!$(e.target).closest("#counterPartyBank, #bankSuggestions").length) {
            $("#bankSuggestions").hide();
        }
    });
/*]]>*/
</script>
<style>
	.page-item.active .page-link {
    z-index: 1;
    color: #fff;
    background-color: darkorange;
    border-color: darkorange;
}
.btn{
font-size: unset !important;
}
.container-fluid {

    width: 100%;
    padding-top:1px;
    padding-right: 0px !important;
    padding-left: 0px !important;
    margin-right: auto;
    margin-left: auto;
}
label,table{
font-family: verdana;
}
</style>
<script>
  $(document).ready(function () {
    const table = $('#usertable').DataTable({
      pageLength: 10,
      lengthChange: false,
      searching: true,
      paging: true,
      ordering: false,
      scrollY: "350px",
      scrollCollapse: true
    });

    

  });
  
  $(document).ready(function () {
	  $('#reportDate').on('change', function () {
	    const reportDate = this.value;

	    $.ajax({
	      type: 'GET',
	      url: './getSwap_Datas',
	      data: { reportDate: reportDate },
	      success: function (data) {
	        const table = $('#usertable').DataTable();
	        table.clear();

	        data.forEach(row => {
	          table.row.add([
    `<div style="text-align:center;">${row.formattedDate}</div>`,  // Centered date
    

    row.dealId,
    row.amount1,
    row.amount2,
    row.rateOrPrice,
    row.security,
    `<div style="text-align:center;">${row.tradeDate}</div>`,  // Centered date
    `<div style="text-align:center;">${row.valueDate}</div>`,  // Centered date
    row.counterpartyCode,
    
	            row.counterpartyName,
	            row.amount,
	            row.residualMaturity,
	            `<div style="text-align:center;">${row.maturityDate}</div>`,  // Centered date
	            row.ccf
	          ]);
	        });

	        table.draw();
	      },
	      error: function (xhr, status, error) {
	        console.error('AJAX error:', status, error);
	        alert('Error fetching data!');
	      }
	    });
	  });
	});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportDate').value = today;
    });
    
    function SettlementLimit() {
        var ReportDate = $("#reportDate").val().trim();
    console.log(ReportDate);
        if (ReportDate === "") {
            alert("Please enter Report Date.");
            $("#reportDate").focus();
            return;
        }
        // Download file with selected branch and date
        window.location.href = './download/SettlementLimit?ReportDate=' + ReportDate;
    }
	
</script>
<script>

function check_date() {
    var iBranchCode = $("#iBranchCode").val().trim();
    var iBranchName = $("#iBranchName").val().trim();
    var reportDate = $("#reportDate").val().trim();
    var fileInput = $("#file")[0].files[0];

    if (!iBranchCode || !iBranchName || !reportDate || !fileInput) {
        alert("All fields are required.");
        return;
    }

    $.ajax({
    	url: "./search_date?reportDate=" + encodeURIComponent(reportDate) + "&iBranchCode=" + encodeURIComponent(iBranchCode)  + "&mode=settlement",
        type: "GET",
        success: function (response) {
            console.log("Success:", response);
            if (response > 0) {
                $("#alertmsg1").text("Report already exists for the selected date.");
                $('#alert1').modal("toggle");
            } else {
                submitform();
            }
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
            $("#alertmsg").text("Error occurred: " + error);
            $('#alert').modal("toggle");
        }
    });
}



function submitform() {
    var iBranchCode = $("#iBranchCode").val().trim();
    var iBranchName = $("#iBranchName").val().trim();
    var reportDate = $("#reportDate").val().trim();
    var fileInput = $("#file")[0].files[0];

    if (!iBranchCode || !iBranchName || !reportDate || !fileInput) {
        alert("All fields are required.");
        return;
    }

    let formData = new FormData();
    formData.append("iBranchCode", iBranchCode);
    formData.append("iBranchName", iBranchName);
    formData.append("reportDate", reportDate);
    formData.append("file", fileInput);
    formData.append("uploadedBy", $("#uploadedBy").val());
    $("#loader1").modal("toggle");
    $.ajax({
        url: "./Add_ASL?mode=settlement",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
        	$("#loader1").modal("hide");
            console.log("Success:", response);
            $("#alertmsg").text(response);
            $('#alert').modal("toggle");
        },
        error: function (xhr, status, error) {
        	$("#loader1").modal("hide");
            console.error("Error:", error);
            $("#alertmsg").text("Error occurred: " + error);
            $('#alert').modal("toggle");
        }
    });
}

function ignore(){
	

	  $("#alertmsg1").text("");
	    $("#alert1").modal("hide");
}
function replace(){
	  $("#alertmsg1").text("");
	    $("#alert1").modal("hide");

    var iBranchCode = $("#iBranchCode").val().trim();
    var iBranchName = $("#iBranchName").val().trim();
    var reportDate = $("#reportDate").val().trim();
    var fileInput = $("#file")[0].files[0];

    if (!iBranchCode || !iBranchName || !reportDate || !fileInput) {
        alert("All fields are required.");
        return;
    }

    let formData = new FormData();
    formData.append("iBranchCode", iBranchCode);
    formData.append("iBranchName", iBranchName);
    formData.append("reportDate", reportDate);
    formData.append("file", fileInput);
    formData.append("uploadedBy", $("#uploadedBy").val());
    $("#loader1").modal("toggle");
    $.ajax({
        url: "./Replace_data?mode=settlement",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
        	$("#loader1").modal("hide");
            console.log("Success:", response);
            $("#alertmsg").text(response);
            $('#alert').modal("toggle");
        },
        error: function (xhr, status, error) {
        	$("#loader1").modal("hide");
            console.error("Error:", error);
            $("#alertmsg").text("Error occurred: " + error);
            $('#alert').modal("toggle");
        }
    });
	
	
}

</script>
<script>
function get_branch() {
    var code = document.getElementById('iBranchCode').value;

    $.ajax({
        type: 'GET',
        url: './getbranch', // or './getbranch' if that's the actual endpoint
        data: { selected_branch: code }, // corrected key-value
        success: function (data) {
        	//alert(data)
            document.getElementById('iBranchName').value = data;
        },
        error: function () {
            alert("Failed to fetch branch name.");
        }
    });
}
</script>
</head>
<title>BCDRS</title>
<body>
	
	<div class="container-fluid">
		<div class="row">
	<div th:insert="XBRLHeaderMenu :: header"></div>
			<div class="col-sm-12">

<div th:if="${formmode}=='add'">
		<div class="row">
			<div class="col-sm-12 ">
<form action="#" method="post" autocomplete="off" id="ASL_report" enctype="multipart/form-data">
						<div class="card">
							<div class="card-header">
								<div class="float-left">
						<h5 th:text="${menu}"
							style="font-family: verdana;  font-weight: bold; padding-top: 10px;"></h5>
					</div>
										<div class="btn-group nav-buttons float-right">
											<button type="button" class="custom-tab-btn"
												onclick="window.location.href='./download/excel?mode=settlement'">
												Template Download</button>
										</div>
									</div>
							<div class="card-body">

								<input autocomplete="false" name="hidden" type="text"
									style="display: none;">
								<div class="form-group">
																<!-- Branch Code Row -->
<div class="row formline">
    <div class="col-sm-3"></div>

    <div class="col-sm-2">
        <label for="iBranchCode">Branch Code <b style="color: red;">*</b></label>
    </div>

    <!-- For ADM: editable input with datalist -->
    <div class="col-sm-3" th:if="${ROLEID == 'ADM'}">
        <input type="text" id="iBranchCode" name="iBranchCode"
               class="form-control form-control-sm"
               list="branchCodeList" autocomplete="off"
               th:value="${BRANCHCODE}" required onchange="get_branch()" />
        <datalist id="branchCodeList">
            <option th:each="code : ${codes}" th:value="${code}"></option>
        </datalist>
    </div>

    <!-- For non-ADM: readonly input -->
    <div class="col-sm-3" th:if="${ROLEID != 'ADM'}">
        <input type="text" id="iBranchCode" name="iBranchCode"
               class="form-control form-control-sm"
               th:value="${BRANCHCODE}" readonly />
    </div>
</div>

<!-- Branch Name Row -->
<div class="row formline">
    <div class="col-sm-3"></div>

    <div class="col-sm-2">
        <label for="iBranchName">Branch Name <b style="color: red;">*</b></label>
    </div>

    <div class="col-sm-3 position-relative">
        <input type="text" id="iBranchName" name="iBranchName"
               class="form-control form-control-sm"
               th:value="${BRANCHNAME}" readonly />
    </div>
</div>
									<div class="row formline">
										<div class="col-sm-3"></div>
										<div class="col-sm-2">
											<label for="file">File<b style="color: red;">*</b></label>
										</div>
										<div class="col-sm-3">
											<input type="file" name="file" id="file"
												class="form-control form-control-sm" autocomplete="new-text"
												required />
										</div>
									</div>
									<div class="row formline">
										<div class="col-sm-3"></div>
										<div class="col-sm-2">
											<label for="uploadedBy">Uploaded By<b style="color: red;">*</b></label>
										</div>
										<div class="col-sm-3">
											<input type="text" name="uploadedBy" id="uploadedBy"
												class="form-control form-control-sm" 
												required th:value="${userid}" readonly  />
										</div>
									</div>
									<div class="row formline">
										<div class="col-sm-3"></div>
										<div class="col-sm-2">
											<label for="reportDate">Report Date<b style="color: red;">*</b></label>
										</div>
										<div class="col-sm-3">
											<input type="date" name="reportDate" id="reportDate"
												class="form-control form-control-sm" 
												required />
										</div>
									</div>
								</div>
								<div class="card-footer text-center">
									<button type="button" class="custom-tab-btn"
										id="btnHome"
										onclick="home();">Home</button>
									<button type="button" class="custom-tab-btn" id="generatebtn"
										onclick="check_date();">Submit</button>
									<button type="button" class="custom-tab-btn"
										id="btnBack"
										onclick="back();">Back</button>

								</div>
							</div>
						</div>
					</form>

				</div>
		</div>
	</div>
		<div th:if="${formmode}=='list'">

			<div class="card" >
				<div class="card-header d-flex justify-content-between align-items-center flex-wrap">
					<h5 th:text="${menu}"
						style="font-family: Verdana;  font-weight: bold; margin: 0;">
					</h5>

					<div class="form-inline">
						<label for="reportDate" class="mr-2">Report Date:</label> <input
							type="date" id="reportDate" name="reportDate"
							class="form-control form-control-sm"
							value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" />
							
							<button type="button" class="custom-tab-btn"
									onclick="SettlementLimit()">Download</button>
					</div>
				</div>


				<div class="row">
				
				<div class="table-container" style="max-height: 620px; overflow-y: auto;">
    <table class="table table-striped table-bordered table-hover" id="usertable">
        <thead style="background-color: orange; font-family: verdana;">
										<tr>
											<th style="white-space: nowrap;">Report Date</th>
											<th style="white-space: nowrap;">Deal ID</th>
											<th style="white-space: nowrap;">Amount 1</th>
											<th style="white-space: nowrap;">Amount 2</th>
											<th style="white-space: nowrap;">Rate / Price</th>
											<th style="white-space: nowrap;">Security</th>
											<th style="white-space: nowrap;">Trade Date</th>
											<th style="white-space: nowrap;">Value Date</th>
											<th style="white-space: nowrap;">Cpty. Code</th>

											<th style="white-space: nowrap;">Counter Party</th>
											<th style="white-space: nowrap;">Amount</th>
											<th style="white-space: nowrap;">Residual Maturity</th>
											<th style="white-space: nowrap;">Maturity Date</th>
											<th style="white-space: nowrap;">CCF (%)</th>
										</tr>
									</thead>
        <tbody style="font-family: verdana;">
            <tr th:each="lists : ${listall}" style="cursor: pointer;">
                <td style="text-align: center" th:text="${#dates.format(lists.reportDate, 'dd-MM-yyyy')}"></td>
                <td  th:text="${lists.dealId}"></td>
                <td  th:text="${lists.amount1}"></td>
                <td  th:text="${lists.amount2}"></td>
                <td  th:text="${lists.rateOrPrice}"></td>
                <td  th:text="${lists.security}"></td>
                <td style="text-align: center" th:text="${#dates.format(lists.tradeDate, 'dd-MM-yyyy')}"></td>
                <td style="text-align: center" th:text="${#dates.format(lists.valueDate, 'dd-MM-yyyy')}"></td>
                <td  th:text="${lists.counterpartyCode}"></td>
                
                
                
                <td  th:text="${lists.counterpartyName}"></td>
                <td  th:text="${lists.amount}" style="text-align: right"></td>
                <td th:text="${lists.residualMaturity}"></td>
                <td style="text-align: center" th:text="${#dates.format(lists.maturityDate, 'dd-MM-yyyy')}"></td>
                <td th:text="${lists.ccf}"></td>
                
            </tr>
        </tbody>
    </table>
</div>

					<div class="card-footer text-center"
						>
						<button type="button" class="custom-tab-btn" id="btnHome"
							onclick="home();">Home</button>
						<button type="button" class="custom-tab-btn" id="btnBack"
							onclick="back();">Back</button>
					</div>
				</div>
			</div>
			</div>
		</div>
		
	
	
	

	
	<div class="modal fade" id="alert">
		<div
			class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
			<div class="menu-title-header">
					<div class="modal-title" id="exampleModalLabel"
						style="text-align: center; color: white;">BANK OF BARODA</div>
				</div>
				<div class="modal-body" style="text-align: center">
					<p id="alertmsg"></p>
					<button type="button" class="custom-tab-btn" onclick="list()"
						data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="loader1" data-backdrop="static"
			data-keyboard="false">
			<div
				class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
				<div class="modal-content" style="background: transparent;">
					<div class="modal-body" style="text-align: center">
						<div>
							<img th:src=@{/images/loader.gif} id="bfirelogo"
								style="width: 153px; height: auto; margin-left: 18px; background-color: transparent;
								border-color: transparent;"
								alt="Bornfire">
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</div>
<div class="modal fade" id="alert1">
		<div
			class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
			<div class="menu-title-header">
					<div class="modal-title" id="exampleModalLabel"
						style="text-align: center; color: white;background-color: darkorange;">BANK OF BARODA</div>
				</div>
				<div class="modal-body" style="text-align: center">
					<p id="alertmsg1"></p>
					<button type="button" class="custom-tab-btn"onclick="replace()"
						data-dismiss="modal">Replace</button>
						<button type="button" class="custom-tab-btn"  data-dismiss="modal"  onclick="ignore();">Ignore</button>

				</div>
			</div>
		</div>
	</div>
</body>
</html>