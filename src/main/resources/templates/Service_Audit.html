<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" type="text/css" href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/font-awesome/5.9.0/css/all.min.css"
	th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
	th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">
<link rel="stylesheet" type="text/css" href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
	th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">
<link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="stylesheet" th:href="@{/css/CustomButton.css}" />

<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
	th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
	th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
<script src="/webjars/jquery/3.4.1/jquery.min.js" th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
	th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>
<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="/webjars/jquery/3.6.0/jquery.min.js" th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
<script src="/webjars/bootstrap/4.6.0/js/bootstrap.bundle.min.js"
	th:src="@{/webjars/bootstrap/4.6.0/js/bootstrap.bundle.min.js}"></script>
<script src="/webjars/datatables.net/1.13.4/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables.net/1.13.4/js/jquery.dataTables.min.js}"></script>

<script th:inline="javascript">

	/*<![CDATA[*/

	$(document).ready(function () {
		var userAuditLevelData = /*[[${userAuditLevels}]]*/[];

		userAuditLevelData.forEach(function (item) {
			if (item.audit_date) {

				const dateObj = new Date(item.audit_date);
				if (!isNaN(dateObj)) {
					const yyyy = dateObj.getFullYear();
					const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
					const dd = String(dateObj.getDate()).padStart(2, '0');
					item.audit_date_filter = `${yyyy}-${mm}-${dd}`;
				} else {
					item.audit_date_filter = '';
				}
			} else {
				item.audit_date_filter = '';
			}
		});

		var table = $('#userAuditLevelTb').DataTable({
			destroy: true,
			scrollCollapse: true,
			paging: true,
			autoWidth: false,
			ordering: true,
			searching: false,
			pageLength: 20,
			lengthChange: false,

			data: userAuditLevelData,
			columns: [
				{data: 'audit_ref_no', title: 'Audit Ref No'},
				{
					data: 'audit_date',
					title: 'Audit Date',
					render: function (data) {
						if (!data) return '';
						const date = new Date(data);
						if (isNaN(date)) return data; // fallback if not a valid date
						return date.toLocaleDateString('en-GB'); // format: dd/mm/yyyy
					}
				},
				{data: 'audit_table', title: 'Audit Table'},
				{data: 'func_code', title: 'Function Code'},
				{data: 'entry_user', title: 'Entry User'},
				{data: 'event_name', title: 'Event Name'},
				{
					data: 'entry_time',
					title: 'Entry Time',
					render: function (data) {
						if (!data) return '';
						const time = new Date(data);
						if (isNaN(time)) return data; // fallback if invalid time
						return time.toLocaleTimeString('en-US', {
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}); // Example output: "05:14 PM"
					}
				},

				{data: 'auth_user', title: 'Auth User'},

				{data: 'remarks', title: 'Remarks'}
			]
		});

		// Date filter event
		$('#searchDate').on('change', function () {
			alert("hi")
			var selectedDate = $(this).val(); // yyyy-mm-dd
			
			var filteredData = userAuditLevelData.filter(function (item) {
				return item.audit_date_filter === selectedDate;
			});

			table.clear().rows.add(filteredData).draw();
		});
	});



	$(function () {

		/* var fromdate;
		var todate; */
		var tabledata = /*[[${AuditList}]]*/ null;


		var table = $('#auditlogtb').DataTable({
			"info": false,
			"lengthChange": false,
			data: tabledata,
			columns: [
				{
					"data": "srl_no",
					"title": "SRL NO"
				},
				{
					"data": "log_in_user_id",
					"title": "ENTRY USER ID"
				},
				{
					"data": "log_in_user_name",
					"title": "ENTRY USER NAME"
				},
				{
					"data": "log_in_designation",
					"title": "DESIGNATION"
				},
				{
					"data": "log_in_contact_no",
					"title": "CONTACT NO"
				},
				{
					"data": "log_in_audit_date",
					"title": "LOGIN DATE"
				},
				{
					"data": "new_user_id",
					"title": "CREATE USER ID"
				},
				{
					"data": "new_user_name",
					"title": "CREATE USER NAME"
				}
			]
		});

		$("#downloadfile").on("click", function () {

			var fromdate2 = $("#fromdate").val();
			var todate2 = $("#todate").val();

			var diff = new Date(todate - fromdate);
			// get days
			var days = diff / 1000 / 60 / 60 / 24;
			if (days <= 31) {
				var url = /*[[@{/auditLogs/Download}]]*/null;


				url = url + "?fromdate=" + fromdate2 + "&todate=" + todate2;
				location.href = url;

			} else {

				$("#alertmsg").text("Maximum 31 days only Allowed");
				$("#alert").modal("toggle");
			}
		});

		

		function format(d) {
			// `d` is the original data object for the row
			var htmlstr;
			var str = d.modified_fields_data;

			var data;
			var modhtml = "";

			if (str != null) {

				data = str.split("|");
				var length = data.length - (data.length % 3);
				var allMods = new Array();
				var count = 0;
				for (i = 0; i < length; i = i + 3) {
					var obj = new Object();
					for (j = i; j < i + 3; j++) {
						if (j % 3 == 0) {
							obj.colname = data[j];
						} else if (j % 3 == 1) {
							obj.oldval = data[j];
						} else {
							obj.newval = data[j];
						}
					}
					console.log(obj);

					allMods[count] = obj;
					count++;

				};

				modhtml = '<tr><td colspan="3">Changed Fields :<td></tr>' +
					'<tr>' +
					'<td>Column Name</td>' +
					'<td>Old Value</td>' +
					'<td>New Value</td>' +
					'</tr>';

				allMods.forEach(function (value) {

					modhtml = modhtml + "<tr><td id='' >" + value.colname + "</td><td id='' class='alnum'>" + value.oldval + "</td><td id='' class='alnum'>" + value.newval + "</td></tr>";

				});

			}

			htmlstr = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
				'<tr>' +
				'<td>Unique Id:</td>' +
				'<td colspan="2">' + d.unique_id + '</td>' +
				'</tr>';

			htmlstr = htmlstr + modhtml + '</table>';

			return htmlstr;
		};


		$('#auditlogtb tbody').on('click', 'td.details-control', function () {
			var tr = $(this).closest('tr');
			var row = table.row(tr);

			if (row.child.isShown()) {
				// This row is already open - close it
				row.child.hide();
				tr.removeClass('shown');
			}
			else {
				// Open this row
				row.child(format(row.data())).show();
				tr.addClass('shown');
			}
		});

	})

	function goHome() {
		window.location.href = '/BCDRS/Dashboard';
	}
	function goBack() {
		window.history.back();
	}

	document.addEventListener("DOMContentLoaded", function () {
		const dateInput = document.getElementById("searchDate");
		const today = new Date().toISOString().substr(0, 10);

		// set today as default value
		dateInput.value = today;

		// disable future dates
		dateInput.max = today;

		// initial filter on load
		filterByDate(dateInput.value);

		// handle date change
		dateInput.addEventListener("change", function () {
			filterByDate(this.value);
		});
	});
	document.getElementById("searchDate").addEventListener("change", function () {
		const selectedDate = this.value;
		filterByDate(selectedDate);
	});

	function filterByDate(dateString) {
		
		const table = document.getElementById("usertable");
		const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

		for (let row of rows) {
			const dateCell = row.cells[4]; // 5th column (Entry Date)
			if (dateCell) {
				// your date format in the table is dd-MM-yyyy
				const cellDateParts = dateCell.textContent.trim().split("-");
				const cellDateFormatted = `${cellDateParts[2]}-${cellDateParts[1]}-${cellDateParts[0]}`; // yyyy-MM-dd
				if (cellDateFormatted === dateString) {
					row.style.display = "";
				} else {
					row.style.display = "none";
				}
			}
		}
	}


	function navigateToid(element) {
		var audit_ref_no = element.getAttribute('data-custid');
		console.log(audit_ref_no);


		$.ajax({
			url: './getchanges',
			type: 'GET',
			data: {
				audit_ref_no: audit_ref_no
			},
			success: function (response) {

				// Split the string using ||| as the delimiter
				let splitData = response.split("|||");

				// Trim whitespace from each part (optional)
				splitData = splitData.map(item => item.trim());

				// Clear existing table rows before appending
				$("#usertablemodel tbody").empty();

				// Access each part individually
				splitData.forEach((entry, index) => {
					// Use a regular expression to extract the column name, old value, and new value
					let regex = /([^:]+): OldValue: ([^,]+), NewValue: (.+)/;

					// Match the data string against the regex
					let match = entry.match(regex);

					if (match) {
						let columnName = match[1].trim(); // Extract the column name
						let oldValue = match[2].trim();  // Extract the old value
						let newValue = match[3].trim();  // Extract the new value


						// Append the extracted values as a new row in the table
						$("#usertablemodel tbody").append(`
	                        <tr>
	                            <td>${columnName}</td>
	                            <td>${oldValue}</td>
	                            <td>${newValue}</td>
	                        </tr>
	                    `);
					} else {
						console.log("No match found for entry");
					}
				});

				// Show the modal
				$('#exampleModalCenter').modal('show');
			},
			error: function (xhr, status, error) {
				alert("An error occurred while processing the request.");
				console.error(xhr, status, error);
			},

		});
	}


</script>


<style>
	.row1 {
		padding-bottom: 10px;
	}

	table.dataTable thead th,
	table.dataTable tfoot th {
		font-weight: normal;
	}

	table.table .thead-light th {
		font-size: 13px;
		border-color: #d4d7da;
	}

	.dataTables_scrollBody {
		overflow: unset !important;
	}

	.dataTables_wrapper .dataTables_paginate .paginate_button {
		padding: 0px;
	}

	td.details-control {
		background: url("images/details_open.png") no-repeat center center;
		cursor: pointer;
	}

	tr.shown td.details-control {
		background: url("images/details_close.png") no-repeat center center;
	}

	/* Style the DataTable header to match the image */
	#userAuditLevelTb thead th {
		background-color: #37474F;
		/* dark blue-gray */
		color: white;
		font-weight: bold;
		font-size: 13px;
		text-align: left;
		border: 1px solid #dee2e6;
	}

	/* Style for table rows */
	#userAuditLevelTb tbody td {
		text-align: left;
		border: 1px solid #dee2e6;
		font-size: 13px;
	}

	/* Zebra striping */
	#userAuditLevelTb tbody tr:nth-child(odd) {
		background-color: #f9f9f9;
	}

	/* No data message color */
	.dataTables_empty {
		color: red !important;
		text-align: center;
	}

	/* Pagination Button Styles */
	.dataTables_wrapper .dataTables_paginate .paginate_button {
		padding: 4px 8px;
		margin: 2px;
		border: 1px solid #ccc;
		background-color: #3d69fc;
		border-radius: 4px;
		font-size: 12px;
	}

	.table-container {
		max-height: 400px;
		overflow-y: auto;
		margin-top: 10px;
	}

	table.fixed-header-table {
		width: 100%;
		border-collapse: collapse;
		table-layout: fixed;
	}

	thead th {
		position: sticky;
		top: 0;
		background: #f8f9fa;
		/* or white */
		z-index: 1;
		border: 1px solid #dee2e6;
		text-align: center;
	}

	table.fixed-header-table th,
	table.fixed-header-table td {
		padding: 8px;
		border: 1px solid #dee2e6;
		text-align: center;
	}

	.table-container {
		max-height: 500px;
		/* You can adjust this height */
		overflow-y: auto;
	}

	.truncate-text {
		white-space: normal;
		/* Allow text to wrap */
		word-wrap: nowrap;
		/* Break long words if necessary */
		overflow: hidden;
		/* Hide the overflowing text */
		text-overflow: ellipsis;
		/* Add ellipsis (...) for truncated text */
		max-width: 300px;
		/* Set a maximum width for the cell */
	}
</style>

</head>
<title>BCDRS</title>

<body>
	<div class="container-fluid">
		<div class="row">
			<div th:insert="XBRLHeaderMenu :: header"></div>
			<div class="col-sm-12">
				<div class="card mt-5">
					<div class="card-header d-flex justify-content-between align-items-center"
						style="background-color: #376275;">
						<h4 class="mb-0" style="color:white">SERVICE LEVEL AUDIT</h4>
						<div class="form-inline">
							<label for="searchDate" class="mr-2 mb-0" style="color:white !important">Search records By
								Date:</label>
							<input type="date" id="searchDate" class="form-control form-control-sm" />
						</div>
					</div>

					<form class="form-horizontal" method="post" name="CriteriaForm" id="reportform">
						<div class="form-group">
							<div class="row row1">
								<!-- Additional criteria inputs can go here -->
							</div>
						</div>
					</form>

					<div class="table-container">
						<table class="table table-striped table-bordered table-hover" id="usertable">
							<thead>
								<tr>
									<th>Cust ID</th>
									<th>Table Name</th>
									<th>Function</th>
									<th>Entry User</th>
									<th>Entry Time</th>
									<th>Authorizer</th>
									<th>Authorizer Time</th>
									<th style="width: 250px;">Modified Data</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="auditdata : ${AuditList}" class="userlist"
									th:attr="data-custid=${auditdata.audit_ref_no ?: 'N/A'}"
									onclick="navigateToid(this)" style="cursor: pointer;">
									<td th:text="${auditdata.report_id ?: 'N/A'}"></td>
									<td th:text="${auditdata.audit_table ?: 'N/A'}"></td>
									<td th:text="${auditdata.func_code ?: 'N/A'}"></td>
									<td
										th:text="${(auditdata.entry_user ?: 'N/A') + ' / ' + (auditdata.entry_user_name ?: 'N/A')}">
									</td>
									
									
									
									<td
										th:text="${auditdata.entry_time != null ? #dates.format(auditdata.entry_time, 'dd-MM-yyyy') : 'N/A'}">
									</td>
									<td
										th:text="${(auditdata.auth_user ?: 'N/A') + ' / ' + (auditdata.auth_user_name ?: 'N/A')}">
									</td>
									<td
										th:text="${auditdata.auth_time != null ? #dates.format(auditdata.auth_time, 'dd-MM-yyyy') : 'N/A'}">
									</td>
									<td th:text="${auditdata.change_details!=null ?auditdata.change_details : 'No details available'}"
										class="truncate-text" style="white-space: nowrap;"></td>
								</tr>

							</tbody>
						</table>
					</div>

					<div class="card-footer text-center">
						<button type="button" class="custom-tab-btn" id="btnHome"
							onclick="goHome();">Home</button>
						<button type="button" class="custom-tab-btn" id="btnBack"
							onclick="goBack();">Back</button>
					</div>
				</div>
			</div>
			<div class="modal fade" id="alert">
				<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content">
						<div class="modal-body" style="text-align: center">
							<p id="alertmsg"></p>
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal" >Close</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
				aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<!-- <div class="modal-header">
						<h5 class="modal-title" id="exampleModalLongTitle"></h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div> -->
						<div class="modal-body">
							<table class="table table-striped table-bordered table-hover " id="usertablemodel">
								<thead>
									<tr>
										<th>Field Name</th>
										<th>Old Value</th>
										<th>New Value</th>
									</tr>
								</thead>
								<tbody>

								</tbody>
							</table>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="close();">Close</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>