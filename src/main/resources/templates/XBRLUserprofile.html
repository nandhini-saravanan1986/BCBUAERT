<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RiskInsights - User Profile</title>

    <!-- CSS Links -->
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}" />
    <link rel="stylesheet" th:href="@{/css/CustomButton.css}" />

    <!-- JavaScript Links -->
    <script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
    <script th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
    <script th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>
    <script th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
    <script th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>

    <style>
        :root {
            --bob-orange: #ff7f27;
            --bob-blue: #004080;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; background-color: #f8f9fa; }

        /* Unified Header Styling */
        #mainHeader { position: sticky; top: 0; z-index: 1060; background: white; }
        .role-page-header { background-color: #ffffff; padding: 15px 20px; border-bottom: 1px solid #dee2e6; }
        
        /* Table Styling - Fixed Width Issue */
        #usertable { width: 100% !important; table-layout: auto !important; }
        #usertable thead th { background-color: #7b6458; color: #fff; text-align: center; padding: 10px; }
        
        /* Form Styling */
        .formline { padding-bottom: 15px; align-items: center; }
        .error { color: red !important; font-size: 11px; display: block; margin-top: 5px; }
        .valids { color: green; font-size: 11px; }
        .invalids { color: red; font-size: 11px; }

        /* Loader Overlay */
        .bob-loader { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(4px); z-index: 9999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .bob-loader.show { visibility: visible; opacity: 1; }

        .role-btn { background: var(--bob-orange); color: white; border: none; padding: 8px 18px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .role-btn:hover { background: #e66d1a; }
        
        input[readonly], select[disabled] { background-color: #e9ecef !important; cursor: not-allowed; }
    </style>

    <script th:inline="javascript">
        /*<![CDATA[*/
        function showLoader() { $('.bob-loader').addClass('show'); }
        function hideLoader() { $('.bob-loader').removeClass('show'); }

        // Navigation Functions
        function list() { showLoader(); location.href = 'UserProfile?formmode=list'; }
        function adduser() { showLoader(); location.href = 'UserProfile?formmode=add'; }
        function back() { window.history.back(); }
        
        function fnView(a) { 
            var userid = a.getAttribute("data-userid");
            showLoader(); location.href = 'UserProfile?formmode=view&userid=' + userid; 
        }
        
        function fnEdit(a) {
            var userid = a.getAttribute("data-userid");
            var workclass = a.getAttribute("data-WORKCLASS");
            if (workclass !== "C" && /*[[${session.ROLEID}]]*/ '' !== "ADM") {
                alert('Access Denied for Modification.');
            } else {
                showLoader(); location.href = 'UserProfile?formmode=edit&userid=' + userid;
            }
        }

        function fnVerify(a) {
            var userid = a.getAttribute("data-userid");
            showLoader(); location.href = 'UserProfile?formmode=verify&userid=' + userid;
        }

        // Dropdown Auto-fills
        function Branchcodeval() {
            var code = $("#branchCode").val();
            var branches = {'9001':'Dubai','9002':'Abu Dhabi','9003':'Deira','9004':'Sharjah','9005':'RAK','9010':'Treasury'};
            $("#branchName").val(branches[code] || "");
        }

		function roledesc() {
		    var roleId = $("#roleId").val();
		    if (!roleId) return;

		    $.ajax({
		        // Change the hardcoded "/BRAS/getRoleDetails" to this:
		        url: /*[[@{/getRoleDetails}]]*/ "/getRoleDetails", 
		        type: "GET",
		        data: { roleId: roleId },
		        success: function (data) {
		            if (data) {
		                $("#role_desc").val(data.roleDesc || "");
		                $("#work_class").val(data.workClass || "");
		                $("#permissions").val(data.permissions || "");
		                $("#domain_id").val(data.domainId || "");
		            }
		        },
		        error: function(xhr) {
		            console.error("Error fetching role: " + xhr.status);
		        }
		    });
		}
        // Custom Validation Helper Functions
        function validateUserId() {
            var regex = /^[A-Za-z]{2}[0-9]{6}$/;
            var val = $("#userId").val();
            if (val && !regex.test(val)) {
                $("#feedbackuser").text("Format: 2 letters + 6 digits (AB123456)").addClass("invalids");
            } else {
                $("#feedbackuser").text("").removeClass("invalids");
            }
        }

        function validatePassword() {
            var p = $("#password").val();
            var strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{14,})/;
            if (p && !strongRegex.test(p)) {
                $("#feedback").html("Min 14 chars, include Upper, Lower, Num, Special").addClass("invalids");
            } else {
                $("#feedback").html("Strong Password").removeClass("invalids").addClass("valids");
            }
        }

        // Form Submission
        function submitForm() {
            if (!$("#userForm").valid()) return;
            showLoader();
            var mode = $("#formmode").val();
            $.ajax({
                url: "./createUser?formmode=" + mode,
                type: 'POST',
                data: $("#userForm").serialize(),
                success: function (res) {
                    hideLoader(); alert(res); list();
                },
                error: function () { hideLoader(); alert("Submission Failed"); }
            });
        }

        // Verification Logic (Maker-Checker check)
        function verifySubmit(btn) {
            var creator = btn.getAttribute("data-modify_user") || btn.getAttribute("data-entry_user");
            var loginUser = /*[[${session.USERID}]]*/ '';
            
            if (creator === loginUser && /*[[${session.ROLEID}]]*/ '' !== 'ADM') {
                alert("Same user cannot verify. (Maker-Checker violation)");
                return;
            }

            if (!confirm("Verify this user?")) return;
            showLoader();
            $.ajax({
                url: './verifyUser',
                type: 'POST',
                data: $('#userForm').serialize(),
                success: function (res) { hideLoader(); alert(res); list(); },
                error: function () { hideLoader(); alert("Error"); }
            });
        }

        $(document).ready(function () {
            $('#usertable').DataTable({ paging: true, searching: true, pageLength: 10 });

            $("#userForm").validate({
                rules: {
                    userid: { required: true },
                    username: "required",
                    email_id: { required: true, email: true },
                    mob_number: { required: true, digits: true, minlength: 12 },
                    password: { required: function() { return $("#formmode").val() === 'add'; } }
                },
                errorPlacement: function(error, element) {
                    error.appendTo(element.parent());
                }
            });
        });
        /*]]>*/
    </script>
</head>

<body>
    <!-- Loader -->
    <div class="bob-loader" role="status">
        <div class="text-center">
            <img th:src="@{/images/bobn.png}" height="60" alt="Loading...">
            <div class="progress mt-2" style="height: 5px; width: 200px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div th:insert="XBRLHeaderMenu :: header" id="mainHeader"></div>

        <!-- LIST VIEW -->
        <div th:if="${formmode == 'list'}" class="mt-3">
            <div class="card">
                <div class="role-page-header d-flex justify-content-between">
                    <h4>User Profiles</h4>
                    <button class="role-btn" th:if="${ROLEIDAC == 'ADM' || ROLEIDAC == 'MGR'}" onclick="adduser()">Create User</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="usertable">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>User Name</th>
                                    <th>Emp ID</th>
                                    <th>Branch Code</th>
                                    <th>Branch Name</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="up : ${userProfiles}">
                                    <td th:text="${up.userid}"></td>
                                    <td th:text="${up.username}"></td>
                                    <td th:text="${up.empid}"></td>
                                    <td th:text="${up.branch_code}"></td>
                                    <td th:text="${up.branch_name}"></td>
                                    <td>
                                        <span th:if="${up.entity_flg == 'Y'}" class="text-success">Verified</span>
                                        <span th:if="${up.entity_flg == 'N'}" class="text-danger">Pending</span>
                                    </td>
                                    <td class="text-center">
                                        <i class="fa fa-edit text-primary mr-2" style="cursor:pointer" title="Edit"
                                           th:attr="data-userid=${up.userid}, data-WORKCLASS=${WORKCLASSAC}" onclick="fnEdit(this)"></i>
                                        <i class="fa fa-eye text-info mr-2" style="cursor:pointer" title="View"
                                           th:attr="data-userid=${up.userid}" onclick="fnView(this)"></i>
                                        <i th:if="${up.entity_flg == 'N'}" class="fa fa-check-circle text-success" 
                                           style="cursor:pointer" title="Verify" th:attr="data-userid=${up.userid}" onclick="fnVerify(this)"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM VIEW (ADD / EDIT / VIEW / VERIFY) -->
        <div th:if="${formmode != 'list'}" class="mt-3">
            <form id="userForm" th:object="${userProfile}" autocomplete="off">
                <input type="hidden" id="formmode" th:value="${formmode}">
                
                <div class="card">
                    <div class="role-page-header d-flex justify-content-between">
                        <h4 th:text="'User Profile - ' + ${#strings.toUpperCase(formmode)}"></h4>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="list()">Back to List</button>
                    </div>

                    <div class="card-body">
                        <!-- Row 1 -->
                        <div class="row formline">
                            <label class="col-sm-2">User ID <span class="text-danger">*</span></label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{userid}" id="userId" class="form-control form-control-sm" 
                                       th:readonly="${formmode != 'add'}" onblur="validateUserId()" maxlength="8">
                                <span id="feedbackuser"></span>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">User Name <span class="text-danger">*</span></label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{username}" class="form-control form-control-sm" 
                                       th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="row formline">
                            <label class="col-sm-2">Bank Code</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{bank_code}" class="form-control form-control-sm" th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Bank Name</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{bank_name}" class="form-control form-control-sm" th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                        </div>

                        <!-- Row 3 -->
                        <div class="row formline">
                            <label class="col-sm-2">Branch Code</label>
                            <div class="col-sm-3">
                                <select th:field="*{branch_code}" id="branchCode" class="form-control form-control-sm" 
                                        th:disabled="${formmode == 'view' || formmode == 'verify'}" onchange="Branchcodeval()">
                                    <option value="">Select</option>
                                    <option value="9001">9001 - Dubai</option>
                                    <option value="9002">9002 - Abu Dhabi</option>
                                    <option value="9010">9010 - Treasury</option>
                                </select>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Branch Name</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{branch_name}" id="branchName" class="form-control form-control-sm" readonly>
                            </div>
                        </div>

                        <!-- Row 4 -->
                        <div class="row formline">
                            <label class="col-sm-2">Employee ID</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{empid}" class="form-control form-control-sm" th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Designation</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{designation}" class="form-control form-control-sm" th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                        </div>

                        <!-- Row 5 -->
                        <div class="row formline">
                            <label class="col-sm-2">Mobile No</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{mob_number}" class="form-control form-control-sm" 
                                       th:readonly="${formmode == 'view' || formmode == 'verify'}" maxlength="12">
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Email ID</label>
                            <div class="col-sm-3">
                                <input type="email" th:field="*{email_id}" class="form-control form-control-sm" 
                                       th:readonly="${formmode == 'view' || formmode == 'verify'}">
                            </div>
                        </div>

                        <!-- Row 6 -->
                        <div class="row formline">
                            <label class="col-sm-2">Password <span th:if="${formmode == 'add'}" class="text-danger">*</span></label>
                            <div class="col-sm-3">
                                <input th:if="${formmode == 'add'}" type="password" name="password" id="password" 
                                       class="form-control form-control-sm" onkeyup="validatePassword()">
                                <input th:if="${formmode != 'add'}" type="text" value="********" class="form-control form-control-sm" readonly>
                                <span id="feedback"></span>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Pass Exp Days</label>
                            <div class="col-sm-3">
                                <select th:field="*{pass_exp_days}" class="form-control form-control-sm" th:disabled="${formmode == 'view' || formmode == 'verify'}">
                                    <option value="60">60 Days</option>
                                    <option value="90">90 Days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 7 -->
                        <div class="row formline">
                            <label class="col-sm-2">User Status</label>
                            <div class="col-sm-3">
                                <select th:field="*{user_status}" class="form-control form-control-sm" th:disabled="${formmode == 'view' || formmode == 'verify'}">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Login Status</label>
                            <div class="col-sm-3">
                                <select th:field="*{login_status}" class="form-control form-control-sm" th:disabled="${formmode == 'view' || formmode == 'verify'}">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <hr>
                        <h5>Role and Rights</h5>

                        <div class="row formline">
                            <label class="col-sm-2">Role ID</label>
                            <div class="col-sm-3">
                                <select th:field="*{role_id}" id="roleId" class="form-control form-control-sm" 
                                        th:disabled="${formmode == 'view' || formmode == 'verify'}" onchange="roledesc()">
                                    <option value="">Select</option>
                                    <option th:each="role : ${RuleIDType}" th:value="${role}" th:text="${role}"></option>
                                </select>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Role Description</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{role_desc}" id="role_desc" class="form-control form-control-sm" readonly>
                            </div>
                        </div>

                        <div class="row formline">
                            <label class="col-sm-2">Work Class</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{work_class}" id="work_class" class="form-control form-control-sm" readonly>
                            </div>
                            <div class="col-sm-1"></div>
                            <label class="col-sm-2">Module</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{domain_id}" id="domain_id" class="form-control form-control-sm" readonly>
                            </div>
                        </div>

                        <div class="row formline">
                            <label class="col-sm-2">Permissions</label>
                            <div class="col-sm-3">
                                <input type="text" th:field="*{permissions}" id="permissions" class="form-control form-control-sm" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer text-center">
                        <button th:if="${formmode == 'add' || formmode == 'edit'}" type="button" class="role-btn" onclick="submitForm()">Submit</button>
                        <button th:if="${formmode == 'verify'}" type="button" class="btn btn-success" 
                                th:attr="data-entry_user=*{entry_user}, data-modify_user=*{modify_user}" onclick="verifySubmit(this)">Verify User</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</body>
</html>