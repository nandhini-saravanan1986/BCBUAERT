<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>RiskInsights - User Profile</title>

	<!-- CSS Links -->
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}" />
	<link rel="stylesheet" th:href="@{/css/CustomButton.css}" />

	<!-- JavaScript Links -->
	<script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
	<script th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<script th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
	<script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
	<script th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>
	<script th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>

	<style>
		:root {
			--bob-orange: #ff7f27;
			--bob-blue: #004080;
		}

		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			font-size: 13px;
			background-color: #f8f9fa;
			height: 100vh;
			overflow-y: auto;
			/* Changed from hidden to allow scrolling if content overflows */
		}

		#mainHeader {
			position: sticky;
			top: 0;
			z-index: 1060;
			background: white;
		}

		.role-page-header {
			background-color: #ffffff;
			padding: 10px 20px;
			border-bottom: 1px solid #dee2e6;
		}

		#usertable thead th {
			background-color: #7b6458;
			color: #fff;
			text-align: center;
			padding: 8px;
		}

		.formline {
			padding-bottom: 15px;
			align-items: center;
		}

		.bob-loader {
			position: fixed;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			background: rgba(255, 255, 255, 0.7);
			backdrop-filter: blur(4px);
			z-index: 9999;
			visibility: hidden;
			opacity: 0;
			transition: 0.3s;
		}

		.bob-loader.show {
			visibility: visible;
			opacity: 1;
		}

		.role-btn {
			background: var(--bob-orange);
			color: white;
			border: none;
			padding: 8px 18px;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
		}

		input[readonly],
		select[disabled] {
			background-color: #e9ecef !important;
			cursor: not-allowed;
		}

		/* Modal Category & Grid Styling */
		.category-head {
			background: #f8f9fa;
			font-weight: bold;
			padding: 5px 10px;
			border-left: 4px solid var(--bob-orange);
			margin: 10px 0;
			color: #333;
		}

		.module-grid {
			display: flex;
			flex-wrap: wrap;
			padding-left: 15px;
		}

		.module-item {
			width: 50%;
			padding: 3px 0;
			font-size: 12px;
		}

		.modal-header {
			background: #7b6458;
			color: white;
		}
	</style>

	<!-- Required Scripts -->
	<script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
	<script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>

	<script th:inline="javascript">
		/*<![CDATA[*/




		function showLoader() {$('.bob-loader').addClass('show');}
		function hideLoader() {$('.bob-loader').removeClass('show');}

		function list() {showLoader(); location.href = 'UserProfile?formmode=list';}
		function adduser() {showLoader(); location.href = 'UserProfile?formmode=add';}

		function fnView(a) {var userid = a.getAttribute("data-userid"); showLoader(); location.href = 'UserProfile?formmode=view&userid=' + userid;}

		function fnEdit(a) {
			var userid = a.getAttribute("data-userid");
			var loggedInRole = /*[[${session.ROLEID}]]*/ '';
			if (loggedInRole === "ADM-M" || loggedInRole === "ADM-C") {
				showLoader(); location.href = 'UserProfile?formmode=edit&userid=' + userid;
			} else {
				alert('Access Denied: Modifications only allowed for Admin roles.');
			}
		}

		function fnVerify(a) {
			var userid = a.getAttribute("data-userid");
			showLoader(); location.href = 'UserProfile?formmode=verify&userid=' + userid;
		}

		function Branchcodeval() {
			var code = $("#branchCode").val();
			var branches = {'9001': 'Dubai', '9002': 'Abu Dhabi', '9010': 'Treasury', '9003': 'Deira', '9006': 'Abu Dhabi', '9007': 'Deira'};
			$("#branchName").val(branches[code] || "");
		}

		function roledesc() {
			var roleId = $("#roleId").val();
			if (!roleId) return;
			$.ajax({
				url: /*[[@{/getRoleDetails}]]*/ "/getRoleDetails",
				type: "GET",
				data: {roleId: roleId},
				success: function (data) {
					if (data) {
						$("#role_desc").val(data.roleDesc || "");
						$("#work_class").val(data.workClass || "");
						$("#permissions").val(data.permissions || "");
						$("#domain_id").val(data.menulist || "");
						syncCheckboxes(data.menulist || "");
					}
				}
			});
		}

		function submitModules() {
			let selected = [];
			$("#permissionForm input[name='domId']:checked").each(function () {
				selected.push($(this).val());
			});
			$("#domain_id").val(selected.join(","));
			$('#moduleModal').modal('hide');
		}

		function syncCheckboxes(menuString) {
			$("#permissionForm input[name='domId']").prop("checked", false);
			if (!menuString) return;
			let menus = menuString.split(",");
			$("#permissionForm input[name='domId']").each(function () {
				if (menus.includes($(this).val())) {
					$(this).prop("checked", true);
				}
			});
		}

		function validateUserId() {
			var regex = /^[A-Za-z]{2}[0-9]{6}$/;
			var val = $("#userid").val();
			if (val && !regex.test(val)) {
				$("#feedbackuser").text("Format: 2 letters + 6 digits").css("color", "red");
			} else {
				$("#feedbackuser").text("");
			}
		}

		function validatePassword() {
			var p = $("#password").val();
			var strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{14,})/;
			if (p && !strongRegex.test(p)) {
				$("#feedback").html("Weak Password").css("color", "red");
			} else {
				$("#feedback").html("Strong Password").css("color", "green");
			}
		}

		function submitForm() {
			if (!$("#userForm").valid()) return;
			showLoader();
			$.ajax({
				url: "./createUser?formmode=" + $("#formmode").val(),
				type: 'POST',
				data: $("#userForm").serialize(),
				success: function (res) {hideLoader(); alert(res); list();},
				error: function () {hideLoader(); alert("Submission Failed");}
			});
		}

		function verifySubmit(btn) {
			var creator = btn.getAttribute("data-entry_user");
			var loginUser = /*[[${session.USERID}]]*/ '';
			if (creator === loginUser) {
				alert("Maker-Checker Violation: Same user cannot verify.");
				return;
			}
			if (!confirm("Verify this profile?")) return;
			showLoader();
			$.ajax({
				url: './verifyUser',
				type: 'POST',
				data: $('#userForm').serialize(),
				success: function (res) {hideLoader(); alert(res); list();}
			});
		}

		$(document).ready(function () {
			$('#usertable').DataTable({
				paging: true, ordering: false, searching: true, pageLength: 10, lengthChange: false,
				dom: '<"d-flex justify-content-between align-items-center mb-2"fp>rt'
			});
			$('#moduleModal').on('show.bs.modal', function () {
				syncCheckboxes($("#domain_id").val());
			});
		});
		/*]]>*/
	</script>
</head>

<body>
	<div class="bob-loader" role="status">
		<div class="text-center">
			<img th:src="@{/images/bobn.png}" height="60" alt="Loading...">
			<div class="progress mt-2" style="height: 5px; width: 200px;">
				<div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 100%">
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid">
		<div th:insert="XBRLHeaderMenu :: header" id="mainHeader"></div>

		<!-- LIST VIEW -->
		<div th:if="${formmode == 'list'}" class="mt-3">
			<div class="role-page-header d-flex justify-content-between align-items-center">
				<h4 class="m-0">User Profile Management</h4>
				<button class="role-btn" th:if="${session.ROLEID == 'ADM-M' OR session.ROLEID == 'ADM-C'}"
					onclick="adduser()">Create User</button>
			</div>
			<div class="card-body bg-white shadow-sm mt-2">
				<div class="table-responsive">
					<table class="table table-hover table-bordered m-0" id="usertable">
						<thead>
							<tr>
								<th>User ID</th>
								<th>User Name</th>
								<th>Emp ID</th>
								<th>Branch Name</th>
								<th>Status</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="up : ${userProfiles}">
								<td th:text="${up.userid}"></td>
								<td th:text="${up.username}"></td>
								<td th:text="${up.empid}"></td>
								<td th:text="${up.branch_name}"></td>
								<td>
									<span th:if="${up.entity_flg == 'Y'}"
										class="text-success font-weight-bold">Verified</span>
									<span th:if="${up.entity_flg == 'N'}"
										class="text-danger font-weight-bold">Pending</span>
								</td>
								<td class="text-center">
									<i class="fa fa-eye text-info mr-3" style="cursor:pointer" title="View"
										th:attr="data-userid=${up.userid}" onclick="fnView(this)"></i>
									<i class="fa fa-edit text-primary mr-3" style="cursor:pointer" title="Edit"
										th:if="${session.ROLEID == 'ADM-M' OR session.ROLEID == 'ADM-C'}"
										th:attr="data-userid=${up.userid}" onclick="fnEdit(this)"></i>
									<i class="fa fa-check-circle text-success" style="cursor:pointer" title="Verify"
										th:if="${session.ROLEID == 'ADM-C' AND up.entity_flg == 'N'}"
										th:attr="data-userid=${up.userid}" onclick="fnVerify(this)"></i>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- FORM VIEW -->
		<div th:if="${formmode != 'list'}" class="mt-3">
			<form id="userForm" th:object="${userProfile}" autocomplete="off">
				<input type="hidden" id="formmode" th:value="${formmode}">
				<div class="card shadow-sm">
					<div class="role-page-header d-flex justify-content-between">
						<h4 class="m-0" th:text="'User Profile - ' + ${#strings.toUpperCase(formmode)}"></h4>
						<button type="button" class="btn btn-secondary btn-sm" onclick="list()">Back to List</button>
					</div>

					<div class="card-body" style="max-height: 70vh; overflow-y: auto;">
						<!-- Row 1 -->
						<div class="row formline">
							<label class="col-sm-2">User ID <span class="text-danger">*</span></label>
							<div class="col-sm-3">
								<input type="text" th:field="*{userid}" id="userid" class="form-control form-control-sm"
									th:readonly="${formmode != 'add'}" onblur="validateUserId()" required>
								<span id="feedbackuser"></span>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">User Name <span class="text-danger">*</span></label>
							<div class="col-sm-3">
								<input type="text" th:field="*{username}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}" required>
							</div>
						</div>

						<!-- Row 2 -->
						<div class="row formline">
							<label class="col-sm-2">Bank Code</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{bank_code}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}">
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Bank Name</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{bank_name}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}">
							</div>
						</div>

						<!-- Row 3 -->
						<div class="row formline">
							<label class="col-sm-2">Branch Code</label>
							<div class="col-sm-3">
								<select th:field="*{branch_code}" id="branchCode" class="form-control form-control-sm"
									th:disabled="${formmode == 'view' || formmode == 'verify'}"
									onchange="Branchcodeval()">
									<option value="">Select</option>
									<option value="9001">9001 - Dubai</option>
									<option value="9002">9002 - Abu Dhabi</option>
									<option value="9010">9010 - Treasury</option>
								</select>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Branch Name</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{branch_name}" id="branchName"
									class="form-control form-control-sm" readonly>
							</div>
						</div>

						<!-- Row 4 -->
						<div class="row formline">
							<label class="col-sm-2">Employee ID</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{empid}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}">
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Designation</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{designation}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}">
							</div>
						</div>

						<!-- Row 5 -->
						<div class="row formline">
							<label class="col-sm-2">Mobile No</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{mob_number}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}" maxlength="12">
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Email ID</label>
							<div class="col-sm-3">
								<input type="email" th:field="*{email_id}" class="form-control form-control-sm"
									th:readonly="${formmode == 'view' || formmode == 'verify'}">
							</div>
						</div>

						<!-- Row 6 -->
						<div class="row formline">
							<label class="col-sm-2">Password <span th:if="${formmode == 'add'}"
									class="text-danger">*</span></label>
							<div class="col-sm-3">
								<input th:if="${formmode == 'add'}" type="password" name="password" id="password"
									class="form-control form-control-sm" onkeyup="validatePassword()" required>
								<input th:if="${formmode != 'add'}" type="text" value="********"
									class="form-control form-control-sm" readonly>
								<span id="feedback"></span>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Pass Exp Days</label>
							<div class="col-sm-3">
								<select th:field="*{pass_exp_days}" class="form-control form-control-sm"
									th:disabled="${formmode == 'view' || formmode == 'verify'}">
									<option value="60">60 Days</option>
									<option value="90">90 Days</option>
								</select>
							</div>
						</div>

						<!-- Row 7 -->
						<div class="row formline">
							<label class="col-sm-2">User Status</label>
							<div class="col-sm-3">
								<select th:field="*{user_status}" class="form-control form-control-sm"
									th:disabled="${formmode == 'view' || formmode == 'verify'}">
									<option value="Active">Active</option>
									<option value="Inactive">Inactive</option>
								</select>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Login Status</label>
							<div class="col-sm-3">
								<select th:field="*{login_status}" class="form-control form-control-sm"
									th:disabled="${formmode == 'view' || formmode == 'verify'}">
									<option value="Active">Active</option>
									<option value="Inactive">Inactive</option>
								</select>
							</div>
						</div>

						<hr>
						<h5 class="mb-4 text-muted">Role and Rights Mapping</h5>

						<div class="row formline">
							<label class="col-sm-2">Role ID</label>
							<div class="col-sm-3">
								<select th:field="*{role_id}" id="roleId" class="form-control form-control-sm"
									th:disabled="${formmode == 'view' || formmode == 'verify'}" onchange="roledesc()">
									<option value="">Select Role</option>
									<option th:each="role : ${RuleIDType}" th:value="${role}" th:text="${role}">
									</option>
								</select>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Role Description</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{role_desc}" id="role_desc"
									class="form-control form-control-sm" readonly>
							</div>
						</div>

						<div class="row formline">
							<label class="col-sm-2">Work Class</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{work_class}" id="work_class"
									class="form-control form-control-sm" readonly>
							</div>
							<div class="col-sm-1"></div>
							<label class="col-sm-2">Module Access <span
									th:if="${formmode == 'add' || formmode == 'edit'}"
									class="text-danger">*</span></label>
							<div class="col-sm-3">
								<div class="input-group">
									<input type="text" th:field="*{domain_id}" id="domain_id"
										class="form-control form-control-sm" readonly required>
									<div class="input-group-append" th:if="${formmode == 'add' || formmode == 'edit'}">
										<button class="btn btn-outline-secondary btn-sm" type="button"
											data-toggle="modal" data-target="#moduleModal"><i
												class="fas fa-search"></i></button>
									</div>
								</div>
							</div>
						</div>

						<div class="row formline">
							<label class="col-sm-2">Permissions</label>
							<div class="col-sm-3">
								<input type="text" th:field="*{permissions}" id="permissions"
									class="form-control form-control-sm" readonly>
							</div>
						</div>

						<div class="card-footer text-center bg-white border-top-0">
							<button th:if="${formmode == 'add' || formmode == 'edit'}" type="button"
								class="role-btn px-5" onclick="submitForm()">Submit</button>
							<button th:if="${formmode == 'verify'}" type="button" class="btn btn-success px-5"
								th:attr="data-entry_user=*{entry_user}" onclick="verifySubmit(this)">Verify
								Profile</button>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>

	<!-- FULL MODULE SELECTION MODAL -->
	<div class="modal fade" id="moduleModal" tabindex="-1" role="dialog" aria-labelledby="moduleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="moduleModalLabel">Access Rights Selection</h5>
					<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" style="max-height: 550px; overflow-y: auto;">
					<form id="permissionForm">
						<div class="category-head">Admin Management</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="Adm-Usrprf"> User
								Profile</div>
							<div class="module-item"><input type="checkbox" name="domId" value="Adm-AccessRole"> Access
								& Roles</div>
							<div class="module-item"><input type="checkbox" name="domId" value="Adm-CustgrpMain">
								Customer Group Maintenance</div>
						</div>
						<div class="category-head">RT Reports</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT1"> Nostro Account
								Balance</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT2"> FX Risk Data
							</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT3"> Trade Market
								Risk</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT4"> MM Data</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT5"> Repo Data
								Template</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT6"> Investment
								Risk Dashboard</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT7"> Treasury
								Credit Limit Management</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT8"> Trade Level
								Data
								Derivatives</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT9"> Trade Level
								Data Simplified</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT10"> CCR Data
								Templates</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT11"> Cross
								Currency Funding
								Spread</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT12"> Liquidity
								Risk Data</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT13"> Investment
								Securities
								Data</div>
							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT14"> Liquidity
								Risk
								Dashboard</div>

							<div class="module-item"><input type="checkbox" name="domId" value="RT-RPT15"> IRRBB Data
								Template</div>
						</div>
						<div class="category-head">ASL & Settlements</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="ASL-Authcounterparty">
								Auth Counterparty</div>
							<div class="module-item"><input type="checkbox" name="domId" value="ASL-Exp_data"> Exposure
								Data</div>
							<div class="module-item"><input type="checkbox" name="domId" value="ASL-Intr_setl">
								Interbank Placements</div>
							<div class="module-item"><input type="checkbox" name="domId" value="ASL-Final_stmt"> ASL
								Final Statement</div>
						</div>
						<div class="category-head">ASL Data Upload</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="Bill-Plac_data">
								Treasury Placement Upload</div>
							<div class="module-item"><input type="checkbox" name="domId" value="Bill-Swap_data">
								Settlement Upload</div>
						</div>
						<div class="category-head">Credit Risk</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="CR-Por_fol_anal">
								Portfolio Analysis</div>
						</div>
						<div class="category-head">Audit Services</div>
						<div class="module-grid">
							<div class="module-item"><input type="checkbox" name="domId" value="Audit-Usr_audit"> User
								Audit</div>
							<div class="module-item"><input type="checkbox" name="domId" value="Audit-Ser_audit">
								Service Audit</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" onclick="submitModules()">Apply Selection</button>
				</div>
			</div>
		</div>
	</div>
</body>

</html>